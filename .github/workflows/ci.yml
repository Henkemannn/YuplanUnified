name: CI

on:
  push:
    branches: [main, master, feat/**, fix/**, chore/**, hotfix/**, release/**, feat/phase-d-conditional-get]
  pull_request:
    branches: [main, master]

jobs:
  backend:
    name: backend (pytest: PG + SQLite)
    runs-on: ubuntu-latest
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: yuplan
        ports: ["5432:5432"]
        options: >-
          --health-cmd "pg_isready -U postgres"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
    steps:
      - uses: actions/checkout@v4
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
          cache: 'pip'
      - name: Install dependencies (ruff + mypy only)
        run: |
          python -m pip install --upgrade pip
          pip install ruff==0.6.3 mypy==1.11.2
      - name: Ruff Lint
        run: |
          ruff check . --output-format=github || (echo "Ruff found issues" && exit 1)
      - name: Mypy Type Check
        run: |
            mypy .

  openapi-validate:
    runs-on: ubuntu-latest
    timeout-minutes: 5
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
          cache: 'pip'
      - name: Install minimal deps
        run: |
          python -m pip install --upgrade pip
          pip install openapi-spec-validator==0.7.1 Flask==3.0.3 rpds-py
      - name: Generate spec via app context
        run: |
          python - <<'PY'
          from core.app_factory import create_app
          app = create_app({'TESTING': True})
          with app.app_context():
              from flask.testing import FlaskClient
              client: FlaskClient = app.test_client()
              spec = client.get('/openapi.json', headers={'X-User-Role':'admin','X-Tenant-Id':'1'}).get_json()
          import json, sys
          open('openapi.json','w').write(json.dumps(spec, indent=2))
          print('Wrote openapi.json with top-level keys:', list(spec.keys()))
          PY
      - name: Validate OpenAPI spec
        run: |
          python - <<'PY'
          import json
          import hashlib, os
          from openapi_spec_validator import validate
          data = json.load(open('openapi.json'))
          validate(data)
          raw = json.dumps(data, sort_keys=True).encode()
          sha = hashlib.sha256(raw).hexdigest()[:12]
          paths = len(data.get('paths',{}))
          schemas = len(data.get('components',{}).get('schemas',{}))
          summary = f"OpenAPI spec validation succeeded. Paths={paths} Schemas={schemas} SHA={sha}\nArtifact: openapi-spec (openapi.json)"
          print(summary)
          with open(os.environ.get('GITHUB_STEP_SUMMARY','/dev/null'),'a') as fh:
              fh.write('### OpenAPI Summary\n')
              fh.write(summary+'\n')
          PY
      - name: Upload OpenAPI artifact
        uses: actions/upload-artifact@v4
        with:
          name: openapi-spec
          path: openapi.json
          if-no-files-found: error

  test:
    needs: [backend, openapi-validate]
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
          cache: 'pip'
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      - name: Show versions
        run: |
          python --version
          pip freeze
      - name: Run migrations (PG)
        env:
          DATABASE_URL: postgresql+psycopg2://postgres:postgres@localhost:5432/yuplan
        run: |
          alembic upgrade head || true
      - name: pytest (Postgres)
        env:
          DATABASE_URL: postgresql+psycopg2://postgres:postgres@localhost:5432/yuplan
          PYTHONWARNINGS: default
        run: pytest -q
      - name: pytest (SQLite)
        env:
          DATABASE_URL: sqlite:///./test.db
          YP_ENABLE_SQLITE_BOOTSTRAP: "1"
          PYTHONWARNINGS: default
        run: pytest -q

      # Phase 2 DoD gate â€“ admin authz must stay green
      - name: Run admin test suite (must stay green)
        env:
          DATABASE_URL: sqlite:///ci.db
        run: |
          pytest tests/admin -v --maxfail=1 --disable-warnings

      - name: Archive test results (optional placeholder)
        if: always()
        run: echo "Add coverage or junit XML export later."
  frontend:
    name: frontend (vitest)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Use Node.js 20
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      - name: Install deps
        run: |
          if [ -f package.json ]; then npm ci; else echo 'No package.json, skipping'; fi
      - name: Run vitest
        run: |
          if [ -f package.json ]; then npm test; else echo 'No package.json, skipping'; fi
