name: CI

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

jobs:
  lint-type:
    runs-on: ubuntu-latest
    timeout-minutes: 5
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
      - name: Install dependencies (ruff + mypy only)
        run: |
          python -m pip install --upgrade pip
          pip install ruff==0.6.3 mypy==1.11.2
      - name: Ruff Lint
        run: |
          ruff check . --output-format=github || (echo "Ruff found issues" && exit 1)
      - name: Mypy Type Check
        run: |
            mypy .

  openapi-validate:
    runs-on: ubuntu-latest
    timeout-minutes: 5
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
      - name: Install dependencies for spec generation
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt || true
          pip install openapi-spec-validator==0.7.1
      - name: Generate spec via app context
        env:
          DATABASE_URL: sqlite:///ci_openapi.db
        run: |
          python - <<'PY'
          from core.app_factory import create_app
          app = create_app({'TESTING': True})
          with app.app_context():
              from flask.testing import FlaskClient
              client: FlaskClient = app.test_client()
              spec = client.get('/openapi.json', headers={'X-User-Role':'admin','X-Tenant-Id':'1'}).get_json()
          import json, sys
          open('openapi.json','w').write(json.dumps(spec, indent=2))
          print('Wrote openapi.json with top-level keys:', list(spec.keys()))
          PY
      - name: Validate OpenAPI spec
        run: |
          python - <<'PY'
          import json
          import hashlib, os
          from openapi_spec_validator import validate
          data = json.load(open('openapi.json'))
          validate(data)
          raw = json.dumps(data, sort_keys=True).encode()
          sha = hashlib.sha256(raw).hexdigest()[:12]
          paths = len(data.get('paths',{}))
          schemas = len(data.get('components',{}).get('schemas',{}))
          summary = f"OpenAPI spec validation succeeded. Paths={paths} Schemas={schemas} SHA={sha}\nArtifact: openapi-spec (openapi.json)"
          print(summary)
          with open(os.environ.get('GITHUB_STEP_SUMMARY','/dev/null'),'a') as fh:
              fh.write('### OpenAPI Summary\n')
              fh.write(summary+'\n')
          PY
      - name: Upload OpenAPI artifact
        uses: actions/upload-artifact@v4
        with:
          name: openapi-spec
          path: openapi.json
          if-no-files-found: error

  test:
    needs: [lint-type, openapi-validate]
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pre-commit

      # Lint & type checks run in the dedicated job (needs: lint-type).
      # Pre-commit in CI tended to drift tool versions and fail on unrelated legacy paths.
      # If needed, re-enable with pinned hooks and repo-wide formatting committed first.
      # - name: Run pre-commit (lint + types)
      #   run: |
      #     pre-commit run --all-files || (echo "pre-commit hook(s) failed" && exit 1)

      - name: pip-audit (advisory)
        continue-on-error: true
        run: |
          pip install pip-audit
          pip-audit || true

      - name: Docs soft check (problems catalog)
        run: |
          if [ ! -f docs/problems.md ]; then echo 'docs/problems.md missing'; exit 1; fi
          grep -q 'Problem Types' docs/problems.md || (echo 'Missing header Problem Types' && exit 1)
          grep -qi 'validation failed' docs/problems.md || (echo 'Missing validation example' && exit 1)
          echo 'problems.md present with expected markers'

      - name: Show versions
        run: |
          python --version
          pip freeze

      - name: Run migrations
        env:
          # Provide empty (or custom) env overrides if your Config.from_env() reads them.
          DATABASE_URL: sqlite:///ci.db
        run: |
          alembic upgrade head

      - name: Run tests
        env:
          DATABASE_URL: sqlite:///ci.db
        run: |
          pip install pytest-cov
          pytest --cov=core --cov=modules --cov-report xml:coverage.xml --cov-report term-missing -q

      - name: Generate coverage badge json
        run: |
          python - <<'PY'
          import xml.etree.ElementTree as ET, json, os
          tree = ET.parse('coverage.xml')
          root = tree.getroot()
          # Cobertura: line-rate attribute
          line_rate = float(root.get('line-rate', '0'))
          pct = round(line_rate * 100, 1)
          color = 'red'
            
          if pct >= 90: color = 'green'
          elif pct >= 80: color = 'yellow'
          elif pct >= 70: color = 'orange'
          badge = {"schemaVersion":1,"label":"coverage","message":f"{pct}%","color":color}
          os.makedirs('status', exist_ok=True)
          with open('status/coverage-badge.json','w') as f: json.dump(badge,f)
          print('Coverage badge written with', pct, '%')
          PY

      - name: Upload coverage artifact
        uses: actions/upload-artifact@v4
        with:
          name: coverage
          path: |
            coverage.xml
            status/coverage-badge.json
          if-no-files-found: error

      - name: Generate SBOM (CycloneDX)
        run: |
          pip install cyclonedx-bom
          cyclonedx-py -o sbom.json

      - name: Upload SBOM artifact
        uses: actions/upload-artifact@v4
        with:
            name: cyclonedx-sbom
            path: sbom.json
            if-no-files-found: error

      - name: Archive test results (optional placeholder)
        if: always()
        run: echo "Add coverage or junit XML export later."

  test-csrf-matrix:
    name: tests (csrf matrix)
    needs: [lint-type, openapi-validate]
    runs-on: ubuntu-latest
    timeout-minutes: 20
    strategy:
      matrix:
        strict: [false, true]
    env:
      STRICT_CSRF_IN_TESTS: ${{ matrix.strict }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      - name: Run tests (matrix)
        run: |
          if [ "${{ matrix.strict }}" = "true" ]; then
            echo 'STRICT MODE: excluding csrf_legacy tests';
            pytest -m "not csrf_legacy" -q;
          else
            echo 'NON-STRICT MODE: full suite';
            pytest -q;
          fi
      - name: Matrix summary
        if: always()
        run: echo "CSRF matrix strict=${{ matrix.strict }} finished" >> $GITHUB_STEP_SUMMARY
