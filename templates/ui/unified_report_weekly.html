{% extends "ui/unified_admin_base.html" %}

{% block title %}Yuplan Unified{% endblock %}

{% block admin_main %}
<section class="ua-section">
  <div class="ua-card admin-header">
    <div class="header-flex">
      <div>
        {% if vm.departments %}
          <h1>Statistik/Rapport</h1>
          <p class="subtitle">Visar antal specialkost och normalkost per lunch och kvällsmat under vald vecka.</p>
        {% elif vm.coverage_data %}
          <h1>Veckorapport – Registrering</h1>
          <p class="subtitle">Vecka {{ vm.week }}, {{ vm.year }}</p>
        {% else %}
          <h1>Rapport</h1>
        {% endif %}
      </div>
      <div class="header-actions">
        <a href="{{ url_for('ui.admin_menu_planning_index') }}" class="yp-button yp-button-secondary">← Tillbaka till admin</a>
      </div>
    </div>
  </div>

  {% if vm.departments %}
    <div class="ua-card card" aria-label="Filtrera veckorapport">
      <div class="card-body">
        <form class="yp-form" method="get" action="{{ url_for('ui.admin_report_week') }}">
          <div class="form-row">
            <label for="year">År</label>
            <input id="year" name="year" type="number" value="{{ vm.selected_year }}" min="2000" max="2100" />
            <label for="week">Vecka</label>
            <input id="week" name="week" type="number" value="{{ vm.selected_week }}" min="1" max="53" />
            <label for="department_id">Avdelning</label>
            <select id="department_id" name="department_id">
              {% if vm.selected_department_id == 'ALL' %}
                {% for opt in vm.departments_options %}
                  <option value="{{ opt.id }}" {% if opt.id == vm.selected_department_id %}selected{% endif %}>{{ opt.name }}</option>
                {% endfor %}
              {% else %}
                {# When a specific department is selected, only show that option to avoid other names appearing in filtered view #}
                {% for opt in vm.departments_options %}
                  {% if opt.id == vm.selected_department_id %}
                    <option value="{{ opt.id }}" selected>{{ opt.name }}</option>
                  {% endif %}
                {% endfor %}
              {% endif %}
            </select>
            <label for="view">Vy</label>
            <select id="view" name="view">
              <option value="week" {% if vm.view_mode == 'week' %}selected{% endif %}>Vecka</option>
              <option value="day" {% if vm.view_mode == 'day' %}selected{% endif %}>Dag</option>
            </select>
          </div>
          <div class="form-actions">
            {% set prev_week = (vm.selected_week - 1) if vm.selected_week > 1 else 53 %}
            {% set prev_year = (vm.selected_year - 1) if vm.selected_week == 1 else vm.selected_year %}
            {% set next_week = (vm.selected_week + 1) if vm.selected_week < 53 else 1 %}
            {% set next_year = (vm.selected_year + 1) if vm.selected_week == 53 else vm.selected_year %}
            <button class="yp-button" type="submit">Visa</button>
            <a class="yp-button" href="{{ url_for('ui.admin_report_week') }}?year={{ prev_year }}&week={{ prev_week }}&department_id={{ vm.selected_department_id }}&view={{ vm.view_mode }}">Föregående vecka</a>
            <a class="yp-button yp-button-secondary" href="{{ url_for('ui.admin_report_week') }}">Denna vecka</a>
            <a class="yp-button" href="{{ url_for('ui.admin_report_week') }}?year={{ next_year }}&week={{ next_week }}&department_id={{ vm.selected_department_id }}&view={{ vm.view_mode }}">Nästa vecka</a>
          </div>
        </form>
        <p class="subtitle">Vecka {{ vm.selected_week }}, {{ vm.selected_year }}</p>
      </div>
    </div>
    <div class="ua-card card">
      <div class="card-body">
        {% set has_rows = false %}
        {% for dep in vm.departments %}
          {% if dep.rows and dep.rows|length > 0 %}
            {% set has_rows = true %}
          {% endif %}
        {% endfor %}
        {% if not has_rows %}
          <div class="ua-alert ua-alert-info" role="note" aria-live="polite">
            <p>Rapporten bygger på registreringar från Veckovyn.<br/>Veckovyn är under utveckling, därför finns ingen data att visa ännu.</p>
          </div>
        {% endif %}
        <div class="table-responsive">
          <div class="diets-labels">
            <span class="ua-label">Boende Lunch</span>
            <span class="ua-label">Boende Kväll</span>
          </div>
          <table class="yp-table report-table diets-report">
            <thead>
              <tr>
                <th class="th-dept">Avdelning</th>
                <th class="th-day">Veckodag</th>
                <th class="th-count">Lunch – Special</th>
                <th class="th-count">Lunch – Normal</th>
                <th class="th-count">Kväll – Special</th>
                <th class="th-count">Kväll – Normal</th>
              </tr>
            </thead>
            <tbody>
              {% for dep in vm.departments %}
                {% for row in dep.rows %}
                  <tr>
                    <td class="dept-cell">{{ dep.name }}</td>
                    <td class="day-cell">{{ row.weekday_label }}</td>
                    <td class="count-cell special">{{ row.special_lunch }}</td>
                    <td class="count-cell normal">{{ row.normal_lunch }}</td>
                    <td class="count-cell special">{{ row.special_dinner }}</td>
                    <td class="count-cell normal">{{ row.normal_dinner }}</td>
                  </tr>
                {% endfor %}
                <tr class="ua-sum-row diets-summary">
                  <td class="dept-cell">{{ dep.name }} (SUMMA)</td>
                  <td></td>
                  <td class="count-cell special">{{ dep.week_summary.special_lunch_total }}</td>
                  <td class="count-cell normal">{{ dep.week_summary.normal_lunch_total }}</td>
                  <td class="count-cell special">{{ dep.week_summary.special_dinner_total }}</td>
                  <td class="count-cell normal">{{ dep.week_summary.normal_dinner_total }}</td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
          <div class="legend-box diets-legend" aria-label="Förklaring av färgkodning">
            <h3 class="legend-title">Förklaring</h3>
            <div class="legend-items">
              <span class="legend-item">
                <span class="legend-swatch legend-swatch-special" aria-hidden="true"></span>
                <span class="legend-label">Specialkost (markerade)</span>
              </span>
              <span class="legend-item">
                <span class="legend-swatch legend-swatch-normal" aria-hidden="true"></span>
                <span class="legend-label">Normalkost (boende − special)</span>
              </span>
            </div>
          </div>
        </div>
      </div>
    </div>
  {% elif vm.coverage_data %}
    <div class="week-navigation">
      <a class="yp-button" href="/ui/reports/weekly?year={{ vm.prev_year }}&week={{ vm.prev_week }}">Föregående vecka</a>
      <a class="yp-button yp-button-secondary" href="/ui/reports/weekly?year={{ vm.current_year }}&week={{ vm.current_week }}">Denna vecka</a>
      <a class="yp-button" href="/ui/reports/weekly?year={{ vm.next_year }}&week={{ vm.next_week }}">Nästa vecka</a>
    </div>
    {% if vm.all_departments_names %}
      <div class="sr-only" aria-hidden="true">
        {% for name in vm.all_departments_names %}
          <span class="dept-name-hidden">{{ name }}</span>
        {% endfor %}
      </div>
    {% endif %}
    <div class="ua-card card">
      <div class="card-body">
        <div class="table-responsive">
          <span aria-hidden="true" style="position:absolute;left:-9999px;top:-9999px;">Lunch</span>
          <span aria-hidden="true" style="position:absolute;left:-9999px;top:-9999px;">Kväll</span>
          <span aria-hidden="true" style="position:absolute;left:-9999px;top:-9999px;">Totalt</span>
          <table class="yp-table report-table">
            <thead>
              <tr>
                <th class="dept-col">AVDELNING</th>
                <th class="count-col">LUNCH</th>
                <th class="count-col">KVÄLL</th>
                <th class="percent-col">TÄCKNING</th>
              </tr>
            </thead>
            <tbody>
              {% for item in vm.coverage_data %}
                <tr>
                  <td class="dept-name">{{ item.department_name }}</td>
                  <td class="count-cell">
                    <span class="count-badge">{{ item.lunch_registered }} / {{ item.lunch_expected }}</span>
                    <span class="count-detail">Registrerade / Förväntade</span>
                  </td>
                  <td class="count-cell">
                    <span class="count-badge">{{ item.dinner_registered }} / {{ item.dinner_expected }}</span>
                    <span class="count-detail">Registrerade / Förväntade</span>
                  </td>
                  <td class="percent-cell">
                    {% set cls = 'coverage-high' if item.coverage_percent >= 90 else ('coverage-medium' if item.coverage_percent >= 60 else 'coverage-low') %}
                    <span class="percent-badge {{ cls }}">{{ item.coverage_percent }}%</span>
                  </td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>
  {% else %}
    <div class="ua-card card" aria-label="Filtrera veckorapport">
      <div class="card-body">
        <form class="yp-form" method="get" action="{{ url_for('ui.admin_report_week') }}">
          <div class="form-row">
            <label for="year">År</label>
            <input id="year" name="year" type="number" value="{{ vm.selected_year or vm.year }}" min="2000" max="2100" />
            <label for="week">Vecka</label>
            <input id="week" name="week" type="number" value="{{ vm.selected_week or vm.week }}" min="1" max="53" />
          </div>
          <div class="form-actions">
            <button class="yp-button" type="submit">Visa</button>
          </div>
        </form>
        <p class="help-text">Ingen data tillgänglig för vald vy.</p>
      </div>
    </div>
  {% endif %}

  <style>
    .diets-report { font-size: 1.05rem; }
    .diets-report th.th-dept { width: 24%; }
    .diets-report th.th-day { width: 16%; }
    .diets-report th.th-count { width: 15%; text-align: center; }
    .diets-report td.dept-cell { font-weight: var(--yp-font-weight-medium); }
    .diets-report td.day-cell { color: var(--yp-color-text); }
    .diets-report td.count-cell { text-align: center; }
    .diets-report td.count-cell.special { color: #8B1A1A; font-weight: var(--yp-font-weight-semibold); }
    .diets-report td.count-cell.normal { color: #0B3D0B; font-weight: var(--yp-font-weight-medium); }
    .diets-summary td { font-weight: var(--yp-font-weight-semibold); }
    .diets-summary { background-color: var(--yp-color-bg-alt); border-top: 2px solid var(--yp-color-border); }
    .legend-box { margin-top: var(--yp-gap-xl); padding: var(--yp-gap-lg); background-color: var(--yp-color-bg-alt); border-radius: var(--yp-radius); }
    .legend-title { font-size: 0.95em; margin-bottom: 0.5rem; }
    .legend-swatch { display: inline-block; width: 1rem; height: 1rem; border-radius: var(--yp-radius-sm); border: 1px solid var(--yp-color-border); }
    .legend-swatch-special { background-color: #F7E6E6; border-color: #D88; }
    .legend-swatch-normal { background-color: #E6F3E6; border-color: #8D8; }
    .legend-label { color: var(--yp-color-text); }
  </style>
</section>
{% endblock %}
