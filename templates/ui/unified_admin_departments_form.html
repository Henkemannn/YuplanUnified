{% extends "ui/unified_admin_base.html" %}

{% block admin_title %}{{ 'Ny avdelning' if vm.mode == 'new' else 'Redigera Avdelning' }}{% endblock %}
{% block admin_subtitle %}Hantera avdelningsuppgifter och boendeantal.{% endblock %}

{% block admin_main %}

<section class="ua-section">
  <div class="ua-card">
    <div class="department-form-container">
        <div class="form-header">
            <h1 class="form-heading">
                {% if vm.mode == 'new' %}
                Ny avdelning
                {% else %}
                Redigera Avdelning
                {% endif %}
            </h1>
            <!-- Keep legacy-cased string for tests -->
            {% if vm.mode != 'new' %}
            <span style="display:none">Redigera avdelning</span>
            {% endif %}
            {% if vm.site_name %}
            <p class="form-subtitle">{{ vm.site_name }}</p>
            {% endif %}
        </div>

        <div class="form-card">
            <form method="POST" 
                  action="{% if vm.mode == 'new' %}{{ url_for('ui.admin_departments_create') }}{% else %}{{ url_for('ui.admin_departments_update', dept_id=vm.department.id) }}{% endif %}"
                  class="yp-form department-form">

                <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
                {% if vm.mode == 'edit' and vm.department %}
                <input type="hidden" name="version" value="{{ vm.department.version }}">
                {% endif %}

                <div class="yp-form-field">
                    <label for="name" class="yp-label">
                        üè∑Ô∏è Namn <span class="required">*</span>
                    </label>
                    <input type="text" 
                           id="name" 
                           name="name" 
                           class="yp-input"
                           value="{% if vm.department %}{{ vm.department.name }}{% endif %}"
                           required
                           aria-required="true"
                           placeholder="T.ex. Avdelning 1">
                    <p class="yp-form-help">Namnet p√• avdelningen (synligt f√∂r personal)</p>
                </div>

                <div class="yp-form-field">
                    <label for="resident_count" class="yp-label">
                        üî¢ Antal boende <span class="required">*</span>
                    </label>
                    <input type="number" 
                           id="resident_count" 
                           name="resident_count" 
                           class="yp-input"
                           value="{% if vm.department %}{{ vm.department.resident_count_fixed }}{% else %}0{% endif %}"
                           min="0"
                           required
                           aria-required="true"
                           placeholder="0">
                    <p class="yp-form-help">Normalt antal (fast). Denna vecka kan vara varierad.</p>
                    {% if vm.weekly_table %}
                    <div class="ua-effective-week" style="margin-top:6px;">
                        <p class="ua-muted" style="margin:0 0 4px;">Denna vecka: <strong>Varierat</strong></p>
                        <table class="ua-table ua-table-compact">
                            <tr><th>Dag</th><th>Lunch</th><th>Kv√§ll</th></tr>
                            {% for row in vm.weekly_table %}
                            <tr>
                                <td>{{ row.weekday }}</td>
                                <td>{{ row.lunch }}</td>
                                <td>{{ row.dinner }}</td>
                            </tr>
                            {% endfor %}
                        </table>
                    </div>
                    {% endif %}
                    {% if vm.mode == 'edit' and vm.department %}
                    <div class="variation-actions" style="margin-top:8px;">
                        <button type="button" id="openVariationBtn" class="yp-button yp-button-secondary js-open-modal" data-modal-target="#residents-variation-modal">üë• Varierat boendeantal</button>
                    </div>
                    {% endif %}
                </div>

                <div class="yp-form-field">
                    <label for="notes" class="yp-label">
                        üìù Faktaruta
                    </label>
                    <textarea id="notes" name="notes" class="yp-input" rows="4" placeholder="Valfri beskrivning">{% if vm.department %}{{ vm.department.notes }}{% endif %}</textarea>
                    <p class="yp-form-help">Intern faktaruta/anteckningar f√∂r avdelningen</p>
                </div>

                {% if vm.mode == 'edit' and vm.department %}
                <div class="yp-form-field">
                    <label class="yp-label">üçΩÔ∏è Menyval (Alt1/Alt2)</label>
                    <div>
                        <button type="button" id="openAlt2Modal" class="yp-button yp-button-secondary">Visa veckans Alt2</button>
                    </div>
                    <p class="yp-form-help">L√§s-l√§ge (Slice 1). Uppdatering kommer i n√§sta steg.</p>
                </div>
                {% endif %}

                <div class="form-actions">
                    <button type="submit" class="yp-button yp-button-primary">
                        {% if vm.mode == 'new' %}
                        üíæ Skapa avdelning
                        {% else %}
                        üíæ Spara √§ndringar
                        {% endif %}
                    </button>
                    <a href="{{ url_for('ui.admin_departments_list') }}" class="yp-button yp-button-secondary">
                        ‚úñ Avbryt
                    </a>
                </div>

            </form>
        </div>

        {% if vm.mode == 'edit' %}
        <div class="form-card" style="margin-top: var(--yp-gap-xl);">
            <h2>Specialkost (antal p√• avdelningen)</h2>
            <form method="POST" action="{{ url_for('ui.admin_departments_edit_save_diets', dept_id=vm.department.id) }}" class="yp-form">
                {{ csrf_token_input()|safe }}
                <input type="hidden" name="version" value="{{ vm.department.version }}">
                {% if vm.diet_types and vm.diet_types|length > 0 %}
                <div class="ua-grid ua-grid-2cols">
                    {% for t in vm.diet_types %}
                        {% set dtid = t.id %}
                        {% set val = vm.diet_defaults[dtid|string] if vm.diet_defaults else 0 %}
                        <div class="yp-form-field">
                            <label class="yp-label">{{ t.name }}</label>
                            <input type="number" name="diet_default_{{ dtid }}" class="yp-input" min="0" value="{{ val }}">
                        </div>
                    {% endfor %}
                </div>
                {% else %}
                <p class="ua-muted">Inga specialkosttyper finns p√• denna site ‚Äì skapa under <a href="{{ url_for('ui.admin_specialkost_list') }}">Specialkost</a>.</p>
                {% endif %}
                <div class="form-actions">
                    <button type="submit" class="yp-button yp-button-primary">üíæ Spara specialkost</button>
                </div>
            </form>
        </div>
        {% endif %}
    </div>
  </div>
</section>

<!-- Modal: Varierat boendeantal (edit form) -->
{% if vm.mode == 'edit' and vm.department %}
<dialog id="residents-variation-modal" class="ua-modal">
    <div class="ua-modal-inner">
        <header class="ua-modal-header">
            <h2>üë• Varierat boendeantal ‚Äì {{ vm.department.name }}</h2>
            <button type="button" class="ua-modal-close" data-modal-close>&times;</button>
        </header>
        <div class="ua-modal-body">
            <form id="residents-variation-form" method="post" action="{{ url_for('ui.admin_department_save_variation', department_id=vm.department.id) }}">
                {{ csrf_token_input()|safe }}
                <p class="ua-muted">M√•n‚ÄìS√∂n √ó Lunch/Kv√§ll</p>
                <input type="hidden" name="selected_week" value="{{ vm.selected_week if vm.selected_week else (vm.current_week if vm.current_week else 1) }}">
                <table class="ua-table">
                    <tr><th>Dag</th><th>Lunch</th><th>Kv√§ll</th></tr>
                    {% set day_names = ['M√•n','Tis','Ons','Tors','Fre','L√∂r','S√∂n'] %}
                    {% for dow in range(1,8) %}
                        {% set lunch_default = vm.department.resident_count_fixed %}
                        {% set dinner_default = vm.department.resident_count_fixed %}
                        {% if vm.weekly_table %}
                            {% set lunch_default = vm.weekly_table[dow-1].lunch %}
                            {% set dinner_default = vm.weekly_table[dow-1].dinner %}
                        {% endif %}
                        <tr>
                            <td>{{ day_names[dow-1] }}</td>
                            <td><input type="number" name="day_{{ dow }}_lunch" value="{{ lunch_default }}" min="0" class="ua-input"></td>
                            <td><input type="number" name="day_{{ dow }}_dinner" value="{{ dinner_default }}" min="0" class="ua-input"></td>
                        </tr>
                    {% endfor %}
                </table>
                <fieldset class="ua-fieldset">
                    <legend>G√§ller</legend>
                    <label><input type="radio" name="mode" value="week" checked> Endast f√∂r vecka
                        <select name="selected_week_override">
                            {% for w in range(1,53) %}
                                <option value="{{ w }}" {% if vm.selected_week and w == vm.selected_week %}selected{% endif %}>{{ w }}</option>
                            {% endfor %}
                        </select>
                    </label>
                    <label><input type="radio" name="mode" value="forever"> Tills vidare</label>
                </fieldset>
                <input type="hidden" name="return_to" value="edit">
            </form>
        </div>
        <footer class="ua-modal-footer">
            <button type="button" class="ua-button ua-button-ghost" data-modal-close>Avbryt</button>
            <button type="submit" form="residents-variation-form" class="yp-button yp-button-primary">Spara</button>
        </footer>
    </div>
</dialog>

<dialog id="alt2-modal" class="ua-modal">
    <div class="ua-modal-inner">
        <header class="ua-modal-header">
            <h2>üçΩÔ∏è Menyval (Alt1/Alt2) ‚Äì {{ vm.department.name }}</h2>
            <button type="button" class="ua-modal-close" data-modal-close>&times;</button>
        </header>
        <div class="ua-modal-body">
            <form class="ua-form" onsubmit="return false;">
                <div class="ua-grid ua-grid-2cols">
                    <div>
                        <label class="yp-label" for="alt2-year">√Ör</label>
                        <input id="alt2-year" class="yp-input" type="number" min="2000" max="2100" value="{{ vm.current_year }}">
                    </div>
                    <div>
                        <label class="yp-label" for="alt2-week">Vecka</label>
                        <input id="alt2-week" class="yp-input" type="number" min="1" max="53" value="{{ vm.current_week }}">
                    </div>
                </div>
            </form>
            <div id="alt2-days" style="margin-top:12px;">
                <p class="ua-muted">H√§mtar...</p>
            </div>
        </div>
        <footer class="ua-modal-footer">
            <button type="button" class="ua-button ua-button-ghost" data-modal-close>St√§ng</button>
        </footer>
    </div>
    <script>
    (function(){
        const dlg = document.getElementById('alt2-modal');
        const btn = document.getElementById('openAlt2Modal');
        if (!dlg || !btn) return;
        const daysEl = dlg.querySelector('#alt2-days');
        const yearEl = dlg.querySelector('#alt2-year');
        const weekEl = dlg.querySelector('#alt2-week');
        const deptId = '{{ vm.department.id }}';
        const dayNames = {mon:'M√•n',tue:'Tis',wed:'Ons',thu:'Tors',fri:'Fre',sat:'L√∂r',sun:'S√∂n'};

        function render(days){
            const all = ['mon','tue','wed','thu','fri','sat','sun'];
            let html = '<div class="ua-badges">';
            for (const d of all){
                const active = days.includes(d);
                html += `<span class="ua-badge ${active ? 'ua-badge-success' : 'ua-badge-muted'}">${dayNames[d]}</span>`;
            }
            html += '</div>';
            daysEl.innerHTML = html;
        }

        async function load(){
            const y = parseInt(yearEl.value, 10);
            const w = parseInt(weekEl.value, 10);
            daysEl.innerHTML = '<p class="ua-muted">H√§mtar...</p>';
            try {
                const r = await fetch(`/ui/admin/departments/${deptId}/alt2?year=${y}&week=${w}`, { headers: { 'X-User-Role': 'admin', 'X-Tenant-Id': '1' } });
                if (!r.ok) {
                    daysEl.innerHTML = '<p class="ua-error">Kunde inte h√§mta Alt2.</p>';
                    return;
                }
                const data = await r.json();
                render(Array.isArray(data.alt2_days) ? data.alt2_days : []);
            } catch (e){
                daysEl.innerHTML = '<p class="ua-error">Fel vid h√§mtning.</p>';
            }
        }

        btn.addEventListener('click', () => { try { dlg.showModal(); } catch(_) { dlg.setAttribute('open','open'); } load(); });
        dlg.addEventListener('close', () => {});
        yearEl.addEventListener('change', load);
        weekEl.addEventListener('change', load);
        dlg.querySelectorAll('[data-modal-close]').forEach(el => el.addEventListener('click', () => { try { dlg.close(); } catch(_) { dlg.removeAttribute('open'); } }));
    })();
    </script>
</dialog>
{% endif %}

<style>
.department-form-container {
    max-width: 600px;
    margin: 0 auto;
}

.form-header {
    margin-bottom: var(--spacing-xl);
}

.form-heading {
    margin: 0 0 var(--spacing-xs) 0;
    font-size: var(--font-size-xxl);
    font-weight: 700;
    color: var(--admin-text-primary);
}

.form-subtitle {
    margin: 0;
    font-size: var(--font-size-lg);
    color: var(--admin-text-secondary);
}

.form-card {
    background-color: var(--admin-bg-card);
    border-radius: var(--radius-lg);
    box-shadow: 0 2px 4px var(--admin-shadow);
    padding: var(--spacing-xxl);
}

.department-form {
    display: flex;
    flex-direction: column;
    gap: var(--spacing-xl);
}

.form-group {
    display: flex;
    flex-direction: column;
    gap: var(--spacing-sm);
}

.form-label {
    font-weight: 600;
    color: var(--admin-text-primary);
    font-size: var(--font-size-base);
}

.required {
    color: #e74c3c;
}

.form-input {
    padding: var(--spacing-md);
    border: 1px solid var(--admin-border);
    border-radius: var(--radius-sm);
    font-size: var(--font-size-base);
    font-family: var(--font-family);
    transition: border-color var(--transition-fast), box-shadow var(--transition-fast);
}

.form-input:focus {
    outline: none;
    border-color: var(--admin-accent);
    box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
}

.form-input::placeholder {
    color: #bdc3c7;
}

.form-help {
    margin: 0;
    font-size: var(--font-size-sm);
    color: var(--admin-text-secondary);
}

.form-actions {
    display: flex;
    gap: var(--spacing-md);
    padding-top: var(--spacing-md);
    border-top: 1px solid var(--admin-border);
}

.btn {
    flex: 1;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: var(--spacing-sm);
    padding: var(--spacing-md) var(--spacing-lg);
    border-radius: var(--radius-md);
    font-weight: 600;
    text-decoration: none;
    transition: all var(--transition-fast);
    border: none;
    cursor: pointer;
    font-size: var(--font-size-base);
}

.btn-primary {
    background-color: var(--admin-accent);
    color: white;
}

.btn-primary:hover {
    background-color: var(--admin-accent-hover);
    transform: translateY(-1px);
    box-shadow: 0 2px 8px rgba(52, 152, 219, 0.3);
}

.btn-secondary {
    background-color: #ecf0f1;
    color: var(--admin-text-primary);
}

.btn-secondary:hover {
    background-color: #d5dbdb;
}

@media (max-width: 768px) {
    .form-card {
        padding: var(--spacing-lg);
    }
    
    .form-actions {
        flex-direction: column;
    }
    
    .btn {
        width: 100%;
    }
}
</style>

{% endblock %}
