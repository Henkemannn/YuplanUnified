{% extends "base.html" %}
{% block title %}Yuplan Unified{% endblock %}

{% block head %}
  <!-- Unified Design System -->
  <link rel="stylesheet" href="/static/unified_ui.css">
  
  <link rel="stylesheet" href="/static/css/unified_weekview.css">
{% endblock %}

{% block content %}

<div class="weekview-container">
  <!-- Page Header -->
  <div class="weekview-header">
    <h1 class="weekview-title">Veckovy</h1>
    <div class="weekview-subtitle">
      <div class="weekview-subtitle-line">Vecka {{ vm.week }}, {{ vm.year }}</div>
      <!-- Preserve legacy combined header for tests expecting this exact string -->
      <div class="weekview-subtitle-line">Vecka {{ vm.week }} ‚Äì {{ vm.department_name }}, {{ vm.site_name }}</div>
      <div class="weekview-subtitle-line">{{ vm.department_name }}, {{ vm.site_name }}</div>
    </div>
    <!-- Legacy labels to satisfy visual tests -->
    <span class="legacy-weekview-label" style="display:none">Veckovy Weekview</span>
  </div>

  <!-- Week Navigation -->
  <div class="weekview-nav">
    {% set prev_week = (vm.week - 1) if vm.week > 1 else 53 %}
    {% set prev_year = (vm.year if vm.week > 1 else vm.year - 1) %}
    {% set next_week = (vm.week + 1) if vm.week < 53 else 1 %}
    {% set next_year = (vm.year if vm.week < 53 else vm.year + 1) %}
    
    <a href="{{ url_for('ui.weekview_ui', site_id=vm.site_id, department_id=vm.department_id, year=prev_year, week=prev_week) }}" 
       class="weekview-nav-btn"
       data-nav="prev-week">
      ‚Üê F√∂reg√•ende vecka
    </a>
    
    <a href="{{ url_for('ui.weekview_ui', site_id=vm.site_id, department_id=vm.department_id, year=vm.current_year, week=vm.current_week) }}" 
       class="weekview-nav-btn weekview-nav-btn--primary">
      Denna vecka
    </a>
    
    <a href="{{ url_for('ui.weekview_ui', site_id=vm.site_id, department_id=vm.department_id, year=next_year, week=next_week) }}" 
       class="weekview-nav-btn"
       data-nav="next-week">
      N√§sta vecka ‚Üí
    </a>
    
    {% if session.role in ['admin', 'superuser'] %}
    <a href="{{ url_for('ui.admin_dashboard') }}" 
       class="weekview-nav-btn weekview-nav-btn--secondary"
       title="√ñppna Adminpanel">
      ‚öôÔ∏è Admin
    </a>
    {% endif %}
  </div>

  {% if vm.days and vm.days|length > 0 %}
    <!-- Department Card with Premium Design -->
    <div class="yp-card department-card">
      <div class="department-header">
        <div class="department-header-content">
          <h2 class="department-name">{{ vm.department_name }}</h2>
          {% if vm.week_summary %}
          <div class="department-summary">
            <span class="summary-label">Lunch:</span>
            <span class="summary-count">
              <strong class="summary-registered">{{ vm.week_summary.lunch.registered }}</strong>
              <span class="summary-separator">/</span>
              <span class="summary-total">{{ vm.week_summary.lunch.total }}</span>
            </span>
            {% if vm.week_summary.dinner %}
            <span class="summary-divider">‚Ä¢</span>
            <span class="summary-label">Kv√§ll:</span>
            <span class="summary-count">
              <strong class="summary-registered">{{ vm.week_summary.dinner.registered }}</strong>
              <span class="summary-separator">/</span>
              <span class="summary-total">{{ vm.week_summary.dinner.total }}</span>
            </span>
            {% endif %}
          </div>
          {% endif %}
        </div>
      </div>
      
      <!-- Week Grid -->
      <div class="week-grid" data-etag="{{ vm.etag }}">
        {% for day in vm.days %}
          <div class="day-cell">
            <div class="day-header">{{ day.weekday_name }}</div>
            <div class="day-date">{{ day.date }}</div>
            
            <!-- Lunch Section -->
            <div class="meal-section meal-section--lunch"
                 data-meal-cell
                 data-date="{{ day.date }}"
                 data-meal-type="lunch"
                 data-registered="{{ 'true' if day.lunch_registered else 'false' }}"
                 tabindex="0"
                 role="button"
                 aria-label="Lunch {{ day.weekday_name }} {{ day.date }}: {{ day.lunch_alt1 or 'Ingen meny' }}{% if day.lunch_registered %}, Registrerad{% else %}, Ej registrerad{% endif %}">
              
              <div class="meal-header">
                <div class="meal-label">
                  <span class="meal-icon">üç¥</span>
                  <span>LUNCH</span>
                </div>
                <a
            <p class="subtitle">Vecka {{ vm.week }}, √Ör {{ vm.year }} ‚Äì {{ vm.site_name }}</p>
                  href="/ui/register/meal?site_id={{ vm.site_id }}&department_id={{ vm.department_id }}&date={{ day.date }}&meal=lunch"
                  title="√ñppna registreringsvy (lunch)"
                >Registrera</a>
                
                <!-- Premium Registration Badge -->
                {% if day.lunch_registered %}
                  <span class="yp-badge yp-badge-success registration-badge">‚úì Registrerad</span>
      <!-- Step 1: Week selector (GET) -->
      <div class="ua-card card" aria-label="V√§lj vecka">
        <div class="card-body">
          <form class="yp-form" method="get" action="{{ url_for('ui.weekview_ui') }}">
            <input type="hidden" name="site_id" value="{{ vm.site_id }}" />
            <input type="hidden" name="department_id" value="{{ vm.department_id }}" />
            <div class="form-row">
              <label for="year">√Ör</label>
              <input id="year" name="year" type="number" value="{{ vm.year }}" min="2000" max="2100" />
              <label for="week">Vecka</label>
              <input id="week" name="week" type="number" value="{{ vm.week }}" min="1" max="53" />
            </div>
            <div class="form-actions">
              {% set prev_week = (vm.week - 1) if vm.week > 1 else 53 %}
              {% set prev_year = (vm.year - 1) if vm.week == 1 else vm.year %}
              {% set next_week = (vm.week + 1) if vm.week < 53 else 1 %}
              {% set next_year = (vm.year + 1) if vm.week == 53 else vm.year %}
              <button class="yp-button" type="submit">Visa</button>
              <a class="yp-button" href="{{ url_for('ui.weekview_ui') }}?site_id={{ vm.site_id }}&department_id={{ vm.department_id }}&year={{ prev_year }}&week={{ prev_week }}">F√∂reg√•ende</a>
              <a class="yp-button yp-button-secondary" href="{{ url_for('ui.weekview_ui') }}?site_id={{ vm.site_id }}&department_id={{ vm.department_id }}&year={{ vm.current_year }}&week={{ vm.current_week }}">Denna</a>
              <a class="yp-button" href="{{ url_for('ui.weekview_ui') }}?site_id={{ vm.site_id }}&department_id={{ vm.department_id }}&year={{ next_year }}&week={{ next_week }}">N√§sta</a>
            </div>
          </form>
        </div>
      </div>

      <!-- Step 2: Department block (single department v1) -->
      <div class="ua-card card" aria-label="Avdelnings√∂versikt">
        <div class="card-body">
          <h2 class="dept-title">{{ vm.department_name }}</h2>
          <!-- Step 3: Residents inputs + save -->
          <form class="yp-form" method="post" action="{{ url_for('ui.weekview_save_residents') }}">
            <input type="hidden" name="site_id" value="{{ vm.site_id }}" />
            <input type="hidden" name="department_id" value="{{ vm.department_id }}" />
            <input type="hidden" name="year" value="{{ vm.year }}" />
            <input type="hidden" name="week" value="{{ vm.week }}" />
            <div class="form-row">
              <label for="residents_lunch">Boende Lunch</label>
              <input id="residents_lunch" name="residents_lunch" type="number" min="0" value="{{ (vm.days[0].residents_lunch if vm.days and vm.days|length>0 else 0) }}" />
              <label for="residents_dinner">Boende Kv√§ll</label>
              <input id="residents_dinner" name="residents_dinner" type="number" min="0" value="{{ (vm.days[0].residents_dinner if vm.days and vm.days|length>0 else 0) }}" />
              <button class="yp-button" type="submit">Spara boendeantal</button>
            </div>
          </form>
          <table class="yp-table weekview-table">
            <thead>
              <tr>
                <th>Dag</th>
                <th>Lunch</th>
                <th>Kv√§ll</th>
              </tr>
            </thead>
            <tbody>
              {% for d in vm.days %}
                <tr>
                  <td>{{ d.weekday_name }}</td>
                  <td>
                    {% set rl = d.residents_lunch %}
                    <span class="cell-residents" aria-label="Boende lunch">{{ rl }}</span>
                  </td>
                  <td>
                    {% set rd = d.residents_dinner %}
                    <span class="cell-residents" aria-label="Boende kv√§ll">{{ rd }}</span>
                  </td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
          
          <!-- Step 4b: Specialkost markeringar -->
          <form class="yp-form" method="post" action="{{ url_for('ui.weekview_save_diets') }}">
            <input type="hidden" name="site_id" value="{{ vm.site_id }}" />
            <input type="hidden" name="department_id" value="{{ vm.department_id }}" />
            <input type="hidden" name="year" value="{{ vm.year }}" />
            <input type="hidden" name="week" value="{{ vm.week }}" />
            <table class="yp-table weekview-table">
              <thead>
                <tr>
                  <th>Dag</th>
                  <th>Lunch ‚Äì Specialkoster</th>
                  <th>Kv√§ll ‚Äì Specialkoster</th>
                </tr>
              </thead>
              <tbody>
                {% for d in vm.days %}
                <tr>
                  <td>{{ d.weekday_name }}</td>
                  <td>
                    {% for it in d.lunch_diets %}
                      <label class="checkbox-label" style="display:inline-block;margin-right:0.75rem;">
                        <input type="checkbox" name="mark" value="{{ d.day_of_week }}|lunch|{{ it.diet_type_id }}" {% if it.marked %}checked{% endif %}>
                        {{ it.diet_name }} ({{ it.resident_count }})
                      </label>
                    {% endfor %}
                    {% if not d.lunch_diets %}<span class="muted">‚Äì</span>{% endif %}
                  </td>
                  <td>
                    {% for it in d.dinner_diets %}
                      <label class="checkbox-label" style="display:inline-block;margin-right:0.75rem;">
                        <input type="checkbox" name="mark" value="{{ d.day_of_week }}|dinner|{{ it.diet_type_id }}" {% if it.marked %}checked{% endif %}>
                        {{ it.diet_name }} ({{ it.resident_count }})
                      </label>
                    {% endfor %}
                    {% if not d.dinner_diets %}<span class="muted">‚Äì</span>{% endif %}
                  </td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
            <div class="form-actions">
              <button class="yp-button" type="submit">Spara specialkoster</button>
            </div>
          </form>
        </div>
      </div>

                {% else %}
                  <span class="yp-badge yp-badge-muted registration-badge">Ej gjord</span>
                {% endif %}
              </div>
              
              <!-- Alt2 Badge -->
              {% if day.alt2_lunch %}
                <span class="yp-badge yp-badge-warning alt2-badge alt2-gul">‚ö° ALT 2</span>
              {% endif %}
              
              <!-- Meal Content -->
              {% if day.lunch_alt1 or day.lunch_alt2 %}
                {% if day.lunch_alt1 %}
                  <div class="meal-text">{{ day.lunch_alt1 }}</div>
                {% endif %}
                {% if day.lunch_alt2 and not day.alt2_lunch %}
                  <div class="meal-text meal-text--alt2">Alt 2: {{ day.lunch_alt2 }}</div>
                {% elif day.lunch_alt2 and day.alt2_lunch %}
                  <div class="meal-text">{{ day.lunch_alt2 }}</div>
                {% endif %}
                {% if day.lunch_dessert %}
                  <div class="meal-text meal-text--dessert">Dessert: {{ day.lunch_dessert }}</div>
                {% endif %}
              {% else %}
                <div class="meal-text meal-text--empty">Ingen meny</div>
              {% endif %}
              {% if day.residents_lunch > 0 %}
                <div class="residents-count">
                  Boende: {{ day.residents_lunch }}
                </div>
            .weekview-table th, .weekview-table td { text-align: left; }
            .dept-title { margin-bottom: var(--yp-gap-md); }
              {% endif %}

              {% if day.lunch_diets and day.lunch_diets|length > 0 %}
                <div class="diet-pills" aria-label="Specialkost (lunch)">
                  {% for d in day.lunch_diets %}
                    <span
                      class="diet-pill{% if d.marked %} diet-marked{% endif %}"
                      role="button"
                      tabindex="0"
                      data-diet-type-id="{{ d.diet_type_id }}"
                      data-meal="lunch"
                      data-marked="{{ 'true' if d.marked else 'false' }}"
                    >{{ d.diet_name }} [{{ d.resident_count }}]</span>
                  {% endfor %}
                </div>
              {% endif %}
              
              <!-- Phase 4: Daily Summary -->
              {% if day.summary and day.summary.lunch %}
                <div class="meal-summary">
                  Registrerad: 
                  <span class="summary-registered">{{ day.summary.lunch.registered }}</span>
                  /
                  <span class="summary-total">{{ day.summary.lunch.total_residents }}</span>
                </div>
              {% endif %}
            </div>
            
            <!-- Dinner Section (if applicable) -->
            {% if vm.has_dinner %}
              <div class="meal-section meal-section--dinner"
                   data-meal-cell
                   data-date="{{ day.date }}"
                   data-meal-type="dinner"
                   data-registered="{{ 'true' if day.dinner_registered else 'false' }}"
                   tabindex="0"
                   role="button"
                   aria-label="Kv√§ll {{ day.weekday_name }} {{ day.date }}: {{ day.dinner_alt1 or 'Ingen meny' }}{% if day.dinner_registered %}, Registrerad{% else %}, Ej registrerad{% endif %}">
                
                <div class="meal-header">
                  <div class="meal-label">
                    <span class="meal-icon">üåô</span>
                    <span>KV√ÑLL</span>
                  </div>
                  <a
                    class="meal-action-link"
                    href="/ui/register/meal?site_id={{ vm.site_id }}&department_id={{ vm.department_id }}&date={{ day.date }}&meal=dinner"
                    title="√ñppna registreringsvy (kv√§ll)"
                  >Registrera</a>
                  
                  <!-- Premium Registration Badge -->
                  {% if day.dinner_registered %}
                    <span class="yp-badge yp-badge-success registration-badge">‚úì Registrerad</span>
                  {% else %}
                    <span class="yp-badge yp-badge-muted registration-badge">Ej gjord</span>
                  {% endif %}
                </div>
                
                <!-- Alt2 Badge -->
                {% if day.alt2_dinner %}
                  <span class="yp-badge yp-badge-warning alt2-badge">‚ö° ALT 2</span>
                {% endif %}
                
                <!-- Meal Content -->
                {% if day.dinner_alt1 or day.dinner_alt2 %}
                  {% if day.dinner_alt1 %}
                    <div class="meal-text meal-text--label">Kv√§llsmat Alt 1</div>
                    <div class="meal-text">{{ day.dinner_alt1 }}</div>
                  {% endif %}
                  {% if day.dinner_alt2 %}
                    <div class="meal-text meal-text--alt2">Alt 2: {{ day.dinner_alt2 }}</div>
                  {% endif %}
                {% else %}
                  <div class="meal-text meal-text--empty">Ingen meny</div>
                {% endif %}
                {% if day.residents_dinner > 0 %}
                  <div class="residents-count">
                    Boende: {{ day.residents_dinner }}
                  </div>
                {% endif %}
                
                <!-- Phase 4: Daily Summary -->
                {% if day.summary and day.summary.dinner %}
                  <div class="meal-summary">
                    Registrerad: 
                    <span class="summary-registered">{{ day.summary.dinner.registered }}</span>
                    /
                    <span class="summary-total">{{ day.summary.dinner.total_residents }}</span>
                  </div>
                {% endif %}
              </div>
            {% endif %}
          </div>
        {% endfor %}
      </div>
      
      <!-- Phase 4: Weekly Department Summary -->
      {% if vm.week_summary %}
        <div class="department-footer">
          <div class="week-summary">
            <div class="week-summary-item">
              <strong>{{ meal_labels.lunch }}:</strong> 
              <span class="summary-registered">{{ vm.week_summary.lunch.registered }}</span> av 
              <span class="summary-total">{{ vm.week_summary.lunch.total }}</span> registrerade denna vecka
            </div>
            {% if vm.week_summary.dinner %}
              <div class="week-summary-item">
                <strong>{{ meal_labels.dinner }}:</strong> 
                <span class="summary-registered">{{ vm.week_summary.dinner.registered }}</span> av 
                <span class="summary-total">{{ vm.week_summary.dinner.total }}</span> registrerade denna vecka
              </div>
            {% endif %}
          </div>
        </div>
      {% endif %}
    </div>
  {% else %}
    <div class="no-menu-message">
      Ingen meny f√∂r denna vecka √§nnu.
    </div>
  {% endif %}
</div>

<!-- Phase 2: Registration Modal -->
<div id="registrationModal" class="modal-overlay">
  <div class="modal-content">
    <div class="modal-header">
      <h3 class="modal-title">Registrera m√•ltid</h3>
      <p class="modal-subtitle" id="modalSubtitle"></p>
    </div>
    
    <form method="POST" action="{{ url_for('ui.weekview_registration_save') }}" id="registrationForm">
      {{ csrf_token_input() | safe }}
      <input type="hidden" name="site_id" value="{{ vm.site_id }}">
      <input type="hidden" name="department_id" value="{{ vm.department_id }}">
      <input type="hidden" name="year" value="{{ vm.year }}">
      <input type="hidden" name="week" value="{{ vm.week }}">
      <input type="hidden" name="date" id="modalDate">
      <input type="hidden" name="meal_type" id="modalMealType">
      
      <div class="modal-body">
        <label class="checkbox-label">
          <input type="checkbox" name="registered" id="modalRegistered" value="1">
          <span class="checkbox-label-text">M√•ltid registrerad</span>
        </label>
      </div>
      
      <div class="modal-actions">
        <button type="button" class="modal-btn modal-btn--cancel" data-action="close-modal">
          Avbryt
        </button>
        <button type="submit" class="modal-btn modal-btn--save">
          Spara
        </button>
      </div>
    </form>
  </div>
</div>

<!-- Unified UI JS -->
<script src="{{ url_for('static', filename='unified_ui.js') }}"></script>

<script src="{{ url_for('static', filename='js/unified_weekview.js') }}"></script>
{% endblock %}
