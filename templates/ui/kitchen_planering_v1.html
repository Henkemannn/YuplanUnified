<!doctype html>
<html lang="sv">
<head>
  <meta charset="utf-8">
  <meta name="csrf-token" content="{{ csrf_meta_token() }}">
  <!-- dev: csrf meta length={{ csrf_meta_token()|length }}; cookie differs from header by design -->
  <title>K√∂k ‚Äì Planering</title>
  <link rel="stylesheet" href="/static/css/unified_cook.css">
  <link rel="stylesheet" href="/static/unified_ui.css">
  <link rel="stylesheet" href="/static/css/kitchen_planering_print.css">
</head>
<body class="cook-dashboard">
  <div class="cook-content">
    <h1 class="section-title">K√∂k ‚Äì Planering</h1>
    {% set _req_mode = request.args.get('mode') %}
    {% set cur_mode = _req_mode if _req_mode in ['special','normal'] else 'special' %}
    {% set show_results = (request.args.get('show_results') == '1') %}

    <!-- Steg 1: Mode -->
    <div class="kp-card kp-mb-12">
      <h2 class="kp-h2-tight">Steg 1 ‚Äì Vad ska du planera?</h2>
      <div class="kp-flex kp-gap-16 kp-align-center kp-flex-wrap">
        <label><input type="radio" name="mode" value="special" {% if cur_mode == 'special' %}checked{% endif %}> Specialkost (anpassningar)</label>
        <label><input type="radio" name="mode" value="normal" {% if cur_mode == 'normal' %}checked{% endif %}> Normalkost (Alt 1 / Alt 2)</label>
      </div>
    </div>

    <!-- Steg 2: Vecka/Dag/M√•ltid -->
    <div class="kp-controls">
      <div class="kp-card">
        <div class="kp-toolbar">
          <h2 class="kp-h2-tight">Steg 2 ‚Äì V√§lj vecka, dag och m√•ltid</h2>
          <div class="kp-week-picker kp-flex kp-gap-8 kp-align-center kp-flex-wrap">
            <a class="kp-button" aria-label="F√∂reg√•ende vecka"
               href="?site_id={{ vm.site_id }}&mode={{ cur_mode }}&year={{ vm.prev_year }}&week={{ vm.prev_week }}&day={{ vm.selected_day if vm.selected_day is not none else '' }}&meal={{ vm.selected_meal or '' }}">‚üµ F√∂reg√•ende</a>
            <form method="get" action="" class="kp-form-row">
              <input type="hidden" name="site_id" value="{{ vm.site_id }}">
              <input type="hidden" name="mode" value="{{ cur_mode }}">
              <input type="hidden" name="day" value="{{ vm.selected_day if vm.selected_day is not none else '' }}">
              <input type="hidden" name="meal" value="{{ vm.selected_meal or '' }}">
              <label for="week-select">Vecka</label>
              <select id="week-select" name="week">
                {% for w in vm.week_options %}
                  <option value="{{ w }}" {% if vm.week == w %}selected{% endif %}>{{ w }}</option>
                {% endfor %}
              </select>
              <label for="year-select">√Ör</label>
              <select id="year-select" name="year">
                {% for y in vm.year_options %}
                  <option value="{{ y }}" {% if vm.year == y %}selected{% endif %}>{{ y }}</option>
                {% endfor %}
              </select>
              <button type="submit" class="kp-button">V√§lj</button>
            </form>
            <a class="kp-button" aria-label="N√§sta vecka"
               href="?site_id={{ vm.site_id }}&mode={{ cur_mode }}&year={{ vm.next_year }}&week={{ vm.next_week }}&day={{ vm.selected_day if vm.selected_day is not none else '' }}&meal={{ vm.selected_meal or '' }}">N√§sta ‚ü∂</a>
          </div>
          <div class="kp-day-buttons">
            {% for label in vm.day_labels %}
              {% set idx = loop.index0 %}
              <a href="?site_id={{ vm.site_id }}&mode={{ cur_mode }}&year={{ vm.year }}&week={{ vm.week }}&day={{ idx }}&meal={{ vm.selected_meal or '' }}"
                 class="kp-button {% if vm.selected_day is not none and vm.selected_day == idx %}is-active{% endif %}">{{ label }}</a>
            {% endfor %}
          </div>
          <div class="kp-meal-buttons">
            <a href="?site_id={{ vm.site_id }}&mode={{ cur_mode }}&year={{ vm.year }}&week={{ vm.week }}&day={{ vm.selected_day if vm.selected_day is not none else '' }}&meal=lunch"
               class="kp-button {% if vm.selected_meal == 'lunch' %}is-active{% endif %}">üçΩÔ∏è Lunch</a>
            <a href="?site_id={{ vm.site_id }}&mode={{ cur_mode }}&year={{ vm.year }}&week={{ vm.week }}&day={{ vm.selected_day if vm.selected_day is not none else '' }}&meal=dinner"
              class="kp-button {% if vm.selected_meal == 'dinner' %}is-active{% endif %}">üåô Kv√§llsmat</a>
            <a href="?site_id={{ vm.site_id }}&mode={{ cur_mode }}&year={{ vm.year }}&week={{ vm.week }}&day={{ vm.selected_day if vm.selected_day is not none else '' }}&meal=dessert"
               class="kp-button {% if vm.selected_meal == 'dessert' %}is-active{% endif %}">üçÆ Dessert</a>
            <button class="kp-button js-print">Skriv ut</button>
            {% if vm.selected_day is not none %}
              <button type="button"
                      class="yp-button"
                      data-action="open-menu-modal"
                      data-site-id="{{ vm.site_id }}"
                      data-year="{{ vm.year }}"
                      data-week="{{ vm.week }}"
                      data-day-index="{{ vm.selected_day }}"
                      {% if vm.selected_meal %}data-focus-meal="{{ vm.selected_meal }}"{% endif %}
              >Visa meny</button>
            {% else %}
              <button type="button" class="yp-button" data-action="open-menu-modal" disabled>Visa meny</button>
            {% endif %}
          </div>
        </div>
      </div>
    </div>

    <!-- Steg 3: Planering/Resultat -->
    <div class="kp-card">
      {% if vm.selected_day is none or vm.selected_meal is none %}
        <div class="empty-state">
          <div class="empty-icon">üìù</div>
          <h2 class="empty-text">V√§lj dag och m√•ltid</h2>
          <p class="empty-text">Planeringen visas h√§r n√§r du gjort ett val.</p>
        </div>
      {% else %}
        <div class="planning-result" id="kp-context" aria-live="polite" data-site-id="{{ vm.site_id }}" data-year="{{ vm.year }}" data-week="{{ vm.week }}" data-day-index="{{ vm.selected_day }}" data-meal="{{ vm.selected_meal }}" data-normal-remaining="{{ (vm.summary and vm.summary.normal_remaining) or 0 }}" data-selected-diets='{{ (vm.selected_diets or [])|tojson }}' data-alt-groups='{{ (vm.alt_groups or {})|tojson }}' data-diet-counts-by-dept='{{ (vm.diet_counts_by_dept or {})|tojson }}' data-special-summary='{{ (vm.special_summary or {})|tojson }}' data-special-total="{{ (vm.special_summary and vm.special_summary.special_total) or 0 }}" data-special-done="{{ (vm.special_summary and vm.special_summary.done_total) or 0 }}" data-special-remaining="{{ (vm.special_summary and vm.special_summary.remaining_total) or 0 }}">
          <div class="kp-card kp-mb-12">
            <h2 class="kp-h2-tight">Vad planerar vi?</h2>
            <div class="kp-flex kp-gap-16 kp-align-center kp-flex-wrap">
              <div>Vecka <strong>{{ vm.week }}</strong>, Dag <strong>{{ vm.day_labels[vm.selected_day] }}</strong>, M√•ltid <strong>{{ 'Lunch' if vm.selected_meal=='lunch' else ( 'Kv√§llsmat' if vm.selected_meal=='dinner' else 'Dessert') }}</strong></div>
            </div>
            {% if vm.selected_meal == 'lunch' %}
            <div class="alt-banners">
              <span class="alt-banner alt1">
                <span class="label">Alt 1:</span>
                <span class="dish"><strong id="kp-lunch-alt1">{{ vm.header_menu.alt1 or '‚Äî' }}</strong></span>
              </span>
              <span class="alt-banner alt2">
                <span class="label">Alt 2:</span>
                <span class="dish"><strong id="kp-lunch-alt2" class="is-alt2 alt2-text">{{ vm.header_menu.alt2 or '‚Äî' }}</strong></span>
              </span>
            </div>
            {% elif vm.selected_meal == 'dinner' %}
              <div>Kv√§llsmat: <strong id="kp-dinner-main">{{ vm.header_menu.dinner or '‚Äî' }}</strong></div>
            {% else %}
              <div>Dessert: <strong id="kp-dessert-main">{{ vm.header_menu.dessert or '‚Äî' }}</strong></div>
            {% endif %}
            <div class="kp-mb-10">
              <label for="whatToCook">Vad ska vi laga?</label>
              <input id="whatToCook" type="text" class="yp-input is-pristine" placeholder="t.ex. kall √∂rts√•s">
            </div>
          </div>

          <!-- Formul√§r steg 3 enligt l√§ge -->
          {% if cur_mode == 'special' %}
            <div class="kp-card kp-mb-12">
              <div class="kp-heading kp-mb-8">Vilka specialkoster beh√∂ver anpassas f√∂r den h√§r r√§tten?</div>
              {% if vm.special_summary and vm.special_summary.totals and vm.special_summary.totals|length > 0 %}
                <div class="kp-chip-grid" data-mode="special" role="group" aria-label="Specialkoster att anpassa">
                  {% for item in vm.special_summary.totals %}
                    {% if item.count > 0 %}
                      <button type="button"
                              class="kp-chip js-special-chip {% if item.diet_type_id in (vm.selected_diets or []) %}is-active{% endif %}"
                              data-diet-id="{{ item.diet_type_id }}"
                              data-total="{{ item.count }}"
                              data-done="{{ item.done }}"
                              data-name="{{ item.diet_type_name }}"
                              aria-pressed="{% if item.diet_type_id in (vm.selected_diets or []) %}true{% else %}false{% endif %}">
                        <span class="kp-chip-title">{{ item.diet_type_name }}</span>
                        <span class="kp-chip-meta">({{ item.count }})</span>
                        <span class="kp-chip-badge">Klart {{ item.done }}/{{ item.count }}</span>
                      </button>
                    {% endif %}
                  {% endfor %}
                </div>
              {% else %}
                <p class="empty-text">Inga specialkoster f√∂r vald dag.</p>
              {% endif %}
            </div>
          {% else %}
            {% if vm.selected_meal == 'lunch' %}
              <div class="kp-card kp-mb-12">
                <h2 class="kp-h2-tight">Vad ska vi laga?</h2>
                <section class="menu-alternatives">
                  <div class="menu-alt alt1">
                    <h3>Alt 1</h3>
                    <input type="text" class="alt-dish-input" data-alt="1" value="{{ vm.header_menu.alt1 or '' }}">
                    <div class="cannot-eat">
                      <span>Kan INTE √§ta:</span>
                      <div class="diet-chips" role="group" aria-label="Specialkoster ‚Äì Alt 1">
                        {% for opt in vm.diet_options %}
                          {% set is_unknown = (not opt.diet_type_name) or (opt.diet_type_name == opt.diet_type_id) %}
                          <button type="button"
                                  class="diet-chip {% if vm.normal_exclusions and (opt.diet_type_id in (vm.normal_exclusions.get('1') or [])) %}active{% endif %}"
                                  data-alt="1"
                                  data-diet-id="{{ opt.diet_type_id }}"
                                  data-total-count="{{ opt.total_count }}" {% if is_unknown %}disabled aria-disabled="true"{% endif %}>{% if is_unknown %}Ok√§nd kosttyp (#{{ opt.diet_type_id }}){% else %}{{ opt.diet_type_name }}{% endif %}</button>
                        {% endfor %}
                      </div>
                    </div>
                  </div>
                  <div class="menu-alt alt2">
                    <h3>Alt 2</h3>
                    <input type="text" class="alt-dish-input" data-alt="2" value="{{ vm.header_menu.alt2 or '' }}">
                    <div class="cannot-eat">
                      <span>Kan INTE √§ta:</span>
                      <div class="diet-chips" role="group" aria-label="Specialkoster ‚Äì Alt 2">
                        {% for opt in vm.diet_options %}
                          {% set is_unknown = (not opt.diet_type_name) or (opt.diet_type_name == opt.diet_type_id) %}
                          <button type="button"
                                  class="diet-chip {% if vm.normal_exclusions and (opt.diet_type_id in (vm.normal_exclusions.get('2') or [])) %}active{% endif %}"
                                  data-alt="2"
                                  data-diet-id="{{ opt.diet_type_id }}"
                                  data-total-count="{{ opt.total_count }}" {% if is_unknown %}disabled aria-disabled="true"{% endif %}>{% if is_unknown %}Ok√§nd kosttyp (#{{ opt.diet_type_id }}){% else %}{{ opt.diet_type_name }}{% endif %}</button>
                        {% endfor %}
                      </div>
                    </div>
                  </div>
                </section>
                <div class="kp-card kp-mt-10">
                  <h3 class="kp-h2-tight">Resultat</h3>
                  <div class="kp-flex kp-gap-16 kp-align-center kp-flex-wrap" aria-live="polite">
                    <div>Alt 1: <strong id="kp-total-alt1">‚Äî</strong></div>
                    <div class="is-alt2">Alt 2: <strong id="kp-total-alt2">‚Äî</strong></div>
                    <div>Totalt: <strong id="kp-total-sum">‚Äî</strong></div>
                  </div>
                  <div id="kp-exclusions-warning" class="kp-warning" style="display:none;">‚ö†Ô∏è Specialkost √∂verstiger boendeantal ‚Äì kontrollera √∂verlapp eller felkoppling.</div>
                </div>
              </div>
            {% else %}
              <div class="kp-card kp-mb-12">
                <h2 class="kp-h2-tight">Vad ska vi laga?</h2>
                <div class="menu-alt">
                  <input type="text" class="alt-dish-input" value="{{ vm.selected_meal == 'dinner' and (vm.header_menu.dinner or '') or (vm.header_menu.dessert or '') }}">
                  <div class="cannot-eat">
                    <span>Kan INTE √§ta:</span>
                    <div class="diet-buttons" role="group" aria-label="Specialkoster">
                      {% for opt in vm.diet_options %}
                        <button type="button" class="kp-button diet-btn" data-diet-type-id="{{ opt.diet_type_id }}">{{ opt.diet_type_name }}</button>
                      {% endfor %}
                    </div>
                  </div>
                </div>
              </div>
            {% endif %}
          {% endif %}

          {% if cur_mode == 'special' %}
            <div class="kp-card kp-mb-12">
              <h2 class="kp-h2-tight">Specialkost ‚Äì √∂versikt</h2>
              {% if vm.special_summary %}
                <div class="kp-special-overview" aria-live="polite">
                  <div>Totalt special: <strong id="kp-special-total">{{ vm.special_summary.special_total }}</strong></div>
                  <div>Klart (markerat): <strong id="kp-special-done">{{ vm.special_summary.done_total }}</strong></div>
                  <div>√Öterst√•r: <strong id="kp-special-remaining">{{ vm.special_summary.remaining_total }}</strong></div>
                </div>
              {% else %}
                <p class="empty-text">Ingen sammanst√§llning tillg√§nglig.</p>
              {% endif %}
            </div>

            {% if vm.special_summary and vm.special_summary.totals and vm.special_summary.totals|length > 0 %}
              <div class="kp-card kp-mb-12">
                <h3>Specialkost ‚Äì sammanst√§llning</h3>
                <table class="grid-table kp-mt-6 kp-card-table">
                  <thead><tr><th>Kosttyp</th><th>Totalt</th><th>Klart</th></tr></thead>
                  <tbody>
                    {% for it in vm.special_summary.totals %}
                      <tr>
                        <td class="kp-text-left">{{ it.diet_type_name }}</td>
                        <td>{{ it.count }}</td>
                        <td>{{ it.done }}</td>
                      </tr>
                    {% endfor %}
                  </tbody>
                </table>
              </div>
            {% endif %}

            {% if vm.special_summary and vm.special_summary.per_department and vm.special_summary.per_department|length > 0 %}
              <div class="kp-card kp-mb-12">
                <h3>Per avdelning</h3>
                <div class="kp-accordion-list">
                  {% for dep in vm.special_summary.per_department %}
                    <details class="kp-accordion">
                      <summary class="kp-accordion-summary">{{ dep.department_name }}</summary>
                      {% if dep['items'] and dep['items']|length > 0 %}
                        <table class="grid-table kp-mt-6 kp-card-table">
                          <thead><tr><th>Kosttyp</th><th>Totalt</th><th>Klart</th></tr></thead>
                          <tbody>
                            {% for row in dep['items'] %}
                              <tr>
                                <td class="kp-text-left">{{ row.diet_type_name }}</td>
                                <td>{{ row.count }}</td>
                                <td>{% if row.done %}{{ row.count }}{% else %}0{% endif %}</td>
                              </tr>
                            {% endfor %}
                          </tbody>
                        </table>
                      {% else %}
                        <div class="empty-text">Inget att anpassa.</div>
                      {% endif %}
                    </details>
                  {% endfor %}
                </div>
              </div>
            {% endif %}

            <h3>Tillagningslista ‚Äì Specialkost <span class="yp-sr-only">(Anpassningslista)</span></h3>
            <div class="kp-card kp-my-8">
              <div class="kp-muted-line">Vecka <strong>{{ vm.week }}</strong> ¬∑ Dag <strong>{{ vm.day_labels[vm.selected_day] }}</strong> ¬∑ M√•ltid <strong>{{ 'Lunch' if vm.selected_meal=='lunch' else ( 'Kv√§llsmat' if vm.selected_meal=='dinner' else 'Dessert') }}</strong></div>
              <div>R√§tt: <strong id="kp-planering-title">
                {% if vm.selected_meal == 'lunch' %}
                  {{ vm.header_menu.alt1 or vm.header_menu.alt2 or '‚Äî' }}
                {% elif vm.selected_meal == 'dinner' %}
                  {{ vm.header_menu.dinner or '‚Äî' }}
                {% else %}
                  {{ vm.header_menu.dessert or '‚Äî' }}
                {% endif %}
              </strong></div>
            </div>
            <div class="kp-card kp-mb-12" id="kp-special-selected">
              <div class="kp-special-selected-summary" aria-live="polite">
                <div>Valda specialkoster: <strong id="kp-special-selected-count">0</strong></div>
                <div>Totalt: <strong id="kp-special-selected-total">0</strong></div>
              </div>
              <div id="kp-special-selected-empty" class="empty-text">V√§lj specialkoster ovan f√∂r att bygga tillagningslistan.</div>
              <div id="kp-special-selected-list" class="kp-special-selected-list"></div>
            </div>
          {% endif %}

          {% if cur_mode == 'normal' %}
            <h3>Normalkost ‚Äì resultat</h3>
            <div class="kp-muted-line">R√§tt: <strong id="kp-planering-title">
              {% if vm.selected_meal == 'lunch' %}
                {% if vm.header_menu.alt2 %}
                  Alt 1: {{ vm.header_menu.alt1 or '‚Äî' }} | Alt 2: {{ vm.header_menu.alt2 }}
                {% else %}
                  Alt 1: {{ vm.header_menu.alt1 or '‚Äî' }}
                {% endif %}
              {% elif vm.selected_meal == 'dinner' %}
                {{ vm.header_menu.dinner or '‚Äî' }}
              {% else %}
                {{ vm.header_menu.dessert or '‚Äî' }}
              {% endif %}
            </strong></div>
            {% if vm.normalkost_rows and vm.normalkost_rows|length > 0 %}
              {% if vm.selected_meal == 'lunch' %}
                <table class="grid-table kp-mt-6">
                  <thead><tr><th>Avdelning</th><th>Alt 1</th><th class="is-alt2">Alt 2</th></tr></thead>
                  <tbody>
                    {% for r in vm.normalkost_rows %}
                      <tr>
                        <td class="kp-text-left">{{ r.department_name }}</td>
                        <td>{{ r.alt1 }}</td>
                        <td class="is-alt2">{{ r.alt2 }}</td>
                      </tr>
                    {% endfor %}
                  </tbody>
                  <tfoot>
                    <tr>
                      <th>TOTALT <span id="kp-base-total" class="yp-sr-only">{{ vm.normalkost_sum.total }}</span></th>
                      <th>
                        <span class="yp-sr-only" id="kp-base-alt1">{{ vm.normalkost_sum.alt1 }}</span>
                        <span data-result-normal="alt1">{{ vm.normalkost_sum.alt1 }}</span>
                      </th>
                      <th class="is-alt2">
                        <span class="yp-sr-only" id="kp-base-alt2">{{ vm.normalkost_sum.alt2 }}</span>
                        <span data-result-normal="alt2">{{ vm.normalkost_sum.alt2 }}</span>
                      </th>
                    </tr>
                  </tfoot>
                </table>
              {% else %}
                <table class="grid-table kp-mt-6">
                  <thead><tr><th>Avdelning</th><th>M√§ngd</th></tr></thead>
                  <tbody>
                    {% for r in vm.normalkost_rows %}
                      <tr>
                        <td class="kp-text-left">{{ r.department_name }}</td>
                        <td>{{ r.total }}</td>
                      </tr>
                    {% endfor %}
                  </tbody>
                  <tfoot>
                    <tr>
                      <th>TOTALT</th>
                      <th>{{ vm.normalkost_sum.total }}</th>
                    </tr>
                  </tfoot>
                </table>
              {% endif %}
            {% else %}
              <p class="empty-text">Inga data f√∂r normalkost.</p>
            {% endif %}
          {% endif %}
        </div>
      {% endif %}
    </div>

  </div>

  {% include "ui/_menu_modal.html" %}

  <!-- Footer scripts (defer for CSP compliance) -->
  <script src="/static/js/menu_utils.js" defer></script>
  <script src="/static/js/menu_modal.js" defer></script>
  <script src="/static/ui/kitchen_planering_v1.js" defer></script>
</body>
</html>
