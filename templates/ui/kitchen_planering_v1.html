<!doctype html>
<html lang="sv">
<head>
  <meta charset="utf-8">
  <title>K√∂k ‚Äì Planering</title>
  <link rel="stylesheet" href="/static/css/unified_cook.css">
  <link rel="stylesheet" href="/static/unified_ui.css">
  <link rel="stylesheet" href="/static/css/kitchen_planering_print.css">
</head>
<body class="cook-dashboard">
  <div class="cook-content">
    <h1 class="section-title">K√∂k ‚Äì Planering</h1>
    {% set _req_mode = request.args.get('mode') %}
    {% set cur_mode = _req_mode if _req_mode in ['special','normal'] else 'special' %}
    {% set show_results = (request.args.get('show_results') == '1') %}

    <!-- Steg 1: Mode -->
    <div class="kp-card" style="margin-bottom:12px;">
      <h2 style="margin:0 0 6px 0;">Steg 1 ‚Äì Vad ska du planera?</h2>
      <div style="display:flex;gap:16px;align-items:center;flex-wrap:wrap;">
        <label><input type="radio" name="mode" value="special" {% if cur_mode == 'special' %}checked{% endif %}> Specialkost (anpassningar)</label>
        <label><input type="radio" name="mode" value="normal" {% if cur_mode == 'normal' %}checked{% endif %}> Normalkost (Alt 1 / Alt 2)</label>
      </div>
    </div>

    <!-- Steg 2: Vecka/Dag/M√•ltid -->
    <div class="kp-controls">
      <div class="kp-card">
        <div class="kp-toolbar">
          <h2 style="margin:0 0 6px 0;">Steg 2 ‚Äì V√§lj vecka, dag och m√•ltid</h2>
          <div class="kp-week-picker" style="display:flex;gap:8px;align-items:center;flex-wrap:wrap;">
            <a class="kp-button" aria-label="F√∂reg√•ende vecka"
               href="?site_id={{ vm.site_id }}&mode={{ cur_mode }}&year={{ vm.prev_year }}&week={{ vm.prev_week }}&day={{ vm.selected_day if vm.selected_day is not none else '' }}&meal={{ vm.selected_meal or '' }}">‚üµ F√∂reg√•ende</a>
            <form method="get" action="" style="display:flex;gap:6px;align-items:center;">
              <input type="hidden" name="site_id" value="{{ vm.site_id }}">
              <input type="hidden" name="mode" value="{{ cur_mode }}">
              <input type="hidden" name="day" value="{{ vm.selected_day if vm.selected_day is not none else '' }}">
              <input type="hidden" name="meal" value="{{ vm.selected_meal or '' }}">
              <label for="week-select">Vecka</label>
              <select id="week-select" name="week">
                {% for w in vm.week_options %}
                  <option value="{{ w }}" {% if vm.week == w %}selected{% endif %}>{{ w }}</option>
                {% endfor %}
              </select>
              <label for="year-select">√Ör</label>
              <select id="year-select" name="year">
                {% for y in vm.year_options %}
                  <option value="{{ y }}" {% if vm.year == y %}selected{% endif %}>{{ y }}</option>
                {% endfor %}
              </select>
              <button type="submit" class="kp-button">V√§lj</button>
            </form>
            <a class="kp-button" aria-label="N√§sta vecka"
               href="?site_id={{ vm.site_id }}&mode={{ cur_mode }}&year={{ vm.next_year }}&week={{ vm.next_week }}&day={{ vm.selected_day if vm.selected_day is not none else '' }}&meal={{ vm.selected_meal or '' }}">N√§sta ‚ü∂</a>
          </div>
          <div class="kp-day-buttons">
            {% for label in vm.day_labels %}
              {% set idx = loop.index0 %}
              <a href="?site_id={{ vm.site_id }}&mode={{ cur_mode }}&year={{ vm.year }}&week={{ vm.week }}&day={{ idx }}&meal={{ vm.selected_meal or '' }}"
                 class="kp-button {% if vm.selected_day is not none and vm.selected_day == idx %}is-active{% endif %}">{{ label }}</a>
            {% endfor %}
          </div>
          <div class="kp-meal-buttons">
            <a href="?site_id={{ vm.site_id }}&mode={{ cur_mode }}&year={{ vm.year }}&week={{ vm.week }}&day={{ vm.selected_day if vm.selected_day is not none else '' }}&meal=lunch"
               class="kp-button {% if vm.selected_meal == 'lunch' %}is-active{% endif %}">üçΩÔ∏è Lunch</a>
            <a href="?site_id={{ vm.site_id }}&mode={{ cur_mode }}&year={{ vm.year }}&week={{ vm.week }}&day={{ vm.selected_day if vm.selected_day is not none else '' }}&meal=dinner"
              class="kp-button {% if vm.selected_meal == 'dinner' %}is-active{% endif %}">üåô Kv√§llsmat</a>
            <a href="?site_id={{ vm.site_id }}&mode={{ cur_mode }}&year={{ vm.year }}&week={{ vm.week }}&day={{ vm.selected_day if vm.selected_day is not none else '' }}&meal=dessert"
               class="kp-button {% if vm.selected_meal == 'dessert' %}is-active{% endif %}">üçÆ Dessert</a>
            <button class="kp-button js-print">Skriv ut</button>
            {% if vm.selected_day is not none %}
              <button type="button"
                      class="kp-button js-open-menu-modal"
                      data-site-id="{{ vm.site_id }}"
                      data-year="{{ vm.year }}"
                      data-week="{{ vm.week }}"
                      data-day-index="{{ vm.selected_day }}"
                      {% if vm.selected_meal %}data-focus-meal="{{ vm.selected_meal }}"{% endif %}
              >Visa meny</button>
            {% else %}
              <button type="button" class="kp-button js-open-menu-modal" disabled>Visa meny</button>
            {% endif %}
          </div>
        </div>
      </div>
    </div>

    <!-- Steg 3: Planering/Resultat -->
    <div class="kp-card">
      {% if vm.selected_day is none or vm.selected_meal is none %}
        <div class="empty-state">
          <div class="empty-icon">üìù</div>
          <h2 class="empty-text">V√§lj dag och m√•ltid</h2>
          <p class="empty-text">Planeringen visas h√§r n√§r du gjort ett val.</p>
        </div>
      {% else %}
        <div class="planning-result" id="kp-context" aria-live="polite" data-year="{{ vm.year }}" data-week="{{ vm.week }}" data-day-index="{{ vm.selected_day }}" data-meal="{{ vm.selected_meal }}">
          <div class="kp-card" style="margin-bottom:12px;">
            <h2 style="margin:0 0 6px 0;">Vad planerar vi?</h2>
            <div style="display:flex;gap:16px;flex-wrap:wrap;align-items:center;">
              <div>Vecka <strong>{{ vm.week }}</strong>, Dag <strong>{{ vm.day_labels[vm.selected_day] }}</strong>, M√•ltid <strong>{{ 'Lunch' if vm.selected_meal=='lunch' else ( 'Kv√§llsmat' if vm.selected_meal=='dinner' else 'Dessert') }}</strong></div>
              {% if vm.selected_meal == 'lunch' %}
                <div>Alt 1: <strong id="kp-lunch-alt1">{{ vm.header_menu.alt1 or '‚Äî' }}</strong></div>
                <div>Alt 2: <strong id="kp-lunch-alt2" class="is-alt2">{{ vm.header_menu.alt2 or '‚Äî' }}</strong></div>
              {% elif vm.selected_meal == 'dinner' %}
                <div>Kv√§llsmat: <strong id="kp-dinner-main">{{ vm.header_menu.dinner or '‚Äî' }}</strong></div>
              {% else %}
                <div>Dessert: <strong id="kp-dessert-main">{{ vm.header_menu.dessert or '‚Äî' }}</strong></div>
              {% endif %}
            </div>
          </div>

          <!-- Formul√§r steg 3 enligt l√§ge -->
          {% if cur_mode == 'special' %}
            <form method="get" action="" class="kp-card" style="margin-bottom:12px;">
              <input type="hidden" name="site_id" value="{{ vm.site_id }}">
              <input type="hidden" name="mode" value="{{ cur_mode }}">
              <input type="hidden" name="year" value="{{ vm.year }}">
              <input type="hidden" name="week" value="{{ vm.week }}">
              <input type="hidden" name="day" value="{{ vm.selected_day }}">
              <input type="hidden" name="meal" value="{{ vm.selected_meal }}">
              <div style="margin-bottom:10px;">
                <label for="kp-what-to-cook" style="display:block; font-weight:600; margin-bottom:6px;">Vad ska vi laga?</label>
                <input type="text" id="kp-what-to-cook" name="what_to_cook" value="" style="width:100%; max-width:520px;" placeholder="t.ex. kall √∂rts√•s">
              </div>
              <div style="margin-bottom:8px; font-weight:600;">Vilka specialkoster beh√∂ver anpassas f√∂r den h√§r r√§tten?</div>
              <div style="display:flex; gap:10px; flex-wrap:wrap;">
                {% for opt in vm.diet_options %}
                  <label style="display:flex; align-items:center; gap:6px;">
                    <input type="checkbox" name="selected_diets" value="{{ opt.diet_type_id }}" {% if opt.diet_type_id in vm.selected_diets %}checked{% endif %}>
                    <span>{{ opt.diet_type_name }}</span>
                    <span style="opacity:0.7;">(totalt {{ opt.total_count }})</span>
                  </label>
                {% endfor %}
              </div>
            </form>
          {% else %}
            <form method="get" action="" class="kp-card" style="margin-bottom:12px;">
              <input type="hidden" name="site_id" value="{{ vm.site_id }}">
              <input type="hidden" name="mode" value="{{ cur_mode }}">
              <input type="hidden" name="year" value="{{ vm.year }}">
              <input type="hidden" name="week" value="{{ vm.week }}">
              <input type="hidden" name="day" value="{{ vm.selected_day }}">
              <input type="hidden" name="meal" value="{{ vm.selected_meal }}">
              {% if vm.selected_meal == 'lunch' %}
                <div style="margin-bottom:6px; font-weight:600;">Vilka kan INTE √§ta Alt 1?</div>
                <div style="display:flex; gap:10px; flex-wrap:wrap; margin-bottom:10px;">
                  {% for opt in vm.diet_options %}
                    <label style="display:flex; align-items:center; gap:6px;">
                      <input type="checkbox" name="selected_diets" value="{{ opt.diet_type_id }}" {% if opt.diet_type_id in vm.selected_diets %}checked{% endif %}>
                      <span>{{ opt.diet_type_name }}</span>
                      <span style="opacity:0.7;">(totalt {{ opt.total_count }})</span>
                    </label>
                  {% endfor %}
                </div>
                <div style="margin-bottom:6px; font-weight:600;">Vilka kan INTE √§ta Alt 2?</div>
                <div style="display:flex; gap:10px; flex-wrap:wrap;">
                  {% for opt in vm.diet_options %}
                    <label style="display:flex; align-items:center; gap:6px;">
                      <input type="checkbox" name="selected_diets" value="{{ opt.diet_type_id }}" {% if opt.diet_type_id in vm.selected_diets %}checked{% endif %}>
                      <span>{{ opt.diet_type_name }}</span>
                      <span style="opacity:0.7;">(totalt {{ opt.total_count }})</span>
                    </label>
                  {% endfor %}
                </div>
              {% else %}
                <div style="margin-bottom:8px; font-weight:600;">Vilka kan INTE √§ta r√§tten?</div>
                <div style="display:flex; gap:10px; flex-wrap:wrap;">
                  {% for opt in vm.diet_options %}
                    <label style="display:flex; align-items:center; gap:6px;">
                      <input type="checkbox" name="selected_diets" value="{{ opt.diet_type_id }}" {% if opt.diet_type_id in vm.selected_diets %}checked{% endif %}>
                      <span>{{ opt.diet_type_name }}</span>
                      <span style="opacity:0.7;">(totalt {{ opt.total_count }})</span>
                    </label>
                  {% endfor %}
                </div>
              {% endif %}
            </form>
          {% endif %}

          {% if cur_mode == 'special' %}
            <h3>Tillagningslista ‚Äì Specialkost <span class="yp-sr-only">(Anpassningslista)</span></h3>
            <div class="kp-card" style="margin:8px 0;">
              <div style="color:#334155; margin-bottom:4px;">Vecka <strong>{{ vm.week }}</strong> ¬∑ Dag <strong>{{ vm.day_labels[vm.selected_day] }}</strong> ¬∑ M√•ltid <strong>{{ 'Lunch' if vm.selected_meal=='lunch' else ( 'Kv√§llsmat' if vm.selected_meal=='dinner' else 'Dessert') }}</strong></div>
              <div>R√§tt: <strong id="kp-special-title">
                {% if vm.selected_meal == 'lunch' %}
                  {{ vm.header_menu.alt1 or vm.header_menu.alt2 or '‚Äî' }}
                {% elif vm.selected_meal == 'dinner' %}
                  {{ vm.header_menu.dinner or '‚Äî' }}
                {% else %}
                  {{ vm.header_menu.dessert or '‚Äî' }}
                {% endif %}
              </strong></div>
            </div>
            {% if vm.adaptation and vm.adaptation|length > 0 %}
              {% for item in vm.adaptation %}
                <div class="kp-card" style="margin:8px 0;">
                  <div style="font-weight:600; margin-bottom:6px;">{{ item.diet_type_name }} ‚Äì totalt {{ item.total_count }}</div>
                  {% if item.per_department and item.per_department|length > 0 %}
                    <ul style="margin:0; padding-left:18px;">
                      {% for row in item.per_department %}
                        <li>{{ row.department_name }}: {{ row.count }}</li>
                      {% endfor %}
                    </ul>
                  {% else %}
                    <div class="empty-text">Inget att anpassa.</div>
                  {% endif %}
                </div>
              {% endfor %}
            {% else %}
              <p class="empty-text">Inga valda specialkoster.</p>
            {% endif %}
          {% endif %}

          {% if cur_mode == 'normal' %}
            <h3>Normalkost ‚Äì resultat</h3>
            {% if vm.normalkost_rows and vm.normalkost_rows|length > 0 %}
              {% if vm.selected_meal == 'lunch' %}
                <table class="grid-table" style="margin-top:6px;">
                  <thead><tr><th>Avdelning</th><th>Alt 1</th><th class="is-alt2">Alt 2</th></tr></thead>
                  <tbody>
                    {% for r in vm.normalkost_rows %}
                      <tr>
                        <td style="text-align:left;">{{ r.department_name }}</td>
                        <td>{{ r.alt1 }}</td>
                        <td class="is-alt2">{{ r.alt2 }}</td>
                      </tr>
                    {% endfor %}
                  </tbody>
                  <tfoot>
                    <tr>
                      <th>TOTALT</th>
                      <th>{{ vm.normalkost_sum.alt1 }}</th>
                      <th class="is-alt2">{{ vm.normalkost_sum.alt2 }}</th>
                    </tr>
                  </tfoot>
                </table>
              {% else %}
                <table class="grid-table" style="margin-top:6px;">
                  <thead><tr><th>Avdelning</th><th>M√§ngd</th></tr></thead>
                  <tbody>
                    {% for r in vm.normalkost_rows %}
                      <tr>
                        <td style="text-align:left;">{{ r.department_name }}</td>
                        <td>{{ r.total }}</td>
                      </tr>
                    {% endfor %}
                  </tbody>
                  <tfoot>
                    <tr>
                      <th>TOTALT</th>
                      <th>{{ vm.normalkost_sum.total }}</th>
                    </tr>
                  </tfoot>
                </table>
              {% endif %}
            {% else %}
              <p class="empty-text">Inga data f√∂r normalkost.</p>
            {% endif %}
          {% endif %}
        </div>
      {% endif %}
    </div>

    <!-- Shared Menu Modal placeholder for js/menu_modal.js -->
    <div id="menuModal" style="display:none"></div>

  </div>

  <!-- Footer scripts (defer for CSP compliance) -->
  <script src="/static/js/menu_modal.js" defer></script>
  <script src="/static/ui/kitchen_planering_v1.js" defer></script>
</body>
</html>
