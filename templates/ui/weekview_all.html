{% extends "ui/unified_admin_base.html" %}

{% block admin_title %}Veckovy ‚Äì vecka {{ vm.week }}, {{ vm.year }}{% endblock %}
{% block admin_subtitle %}Alla avdelningar ({{ vm.site_name }}){% endblock %}

{% block admin_main %}

<style>
  /* iPad-first: larger, comfortable targets */
  .weekview-all { font-size: 18px; line-height: 1.55; }
  .weekview-all .ua-card { padding: 16px 16px; }
  .weekview-all h2 { margin: 0 0 6px 0; font-size: 20px; }
  .meta-row { color: #666; font-size: 14px; margin-bottom: 8px; }
  table.weekview { width: 100%; border-collapse: separate; border-spacing: 0; }
  table.weekview th, table.weekview td { text-align:center; padding: 8px 6px; }
  table.weekview thead th { position: sticky; top: 0; z-index: 5; background: #fff; box-shadow: 0 1px 0 rgba(0,0,0,0.06); }
  table.weekview thead tr:nth-child(2) th { top: 32px; z-index: 6; }
  table.weekview th + th, table.weekview td + td { border-left: 1px solid rgba(0,0,0,0.08); }
  table.weekview tbody tr:nth-child(even) { background: rgba(0,0,0,0.015); }
  table.weekview tbody tr.boende-row { background: rgba(33,150,243,0.06); font-weight: 600; }
  td.kvall { background: rgba(0,0,0,0.03); }
  td.diet-cell { cursor: pointer; user-select: none; }
  td.diet-cell.marked { outline: 2px solid #2e7d32; background: rgba(46,125,50,0.08); }
  .legend { font-size: 13px; color: #555; display: flex; gap: 16px; align-items:center; margin: 8px 0 0 0; }
  .legend .pill { display:inline-block; padding: 2px 6px; border-radius: 4px; background: rgba(0,0,0,0.06); }
  .legend .pill.kvall { background: rgba(0,0,0,0.08); }
  .legend .pill.marked { outline: 2px solid #2e7d32; background: rgba(46,125,50,0.12); }
  /* Optional sticky dep header within card */
  .dep-header { position: sticky; top: 0; background: #fff; z-index: 7; padding-bottom: 4px; }
  /* Snackbar */
  .snackbar { position: fixed; left: 50%; bottom: 20px; transform: translateX(-50%); background: #323232; color: #fff; padding: 10px 14px; border-radius: 6px; opacity: 0; pointer-events:none; transition: opacity 150ms ease-in-out; font-size: 14px; }
  .snackbar.show { opacity: 1; }
  .snackbar.error { background: #c62828; }
  /* Cards & table softening */
  .weekview-all .ua-card { border-radius: 10px; box-shadow: 0 6px 18px rgba(0,0,0,0.08); }
  table.weekview th + th, table.weekview td + td { border-left: 1px solid rgba(0,0,0,0.05); }
  table.weekview tbody tr:nth-child(even) { background: rgba(0,0,0,0.01); }
  /* Department info-box */
  .dep-info { background: rgba(33,150,243,0.08); border-radius: 8px; padding: 10px 12px; margin: 8px 0 12px 0; color:#29434e; display:flex; align-items:flex-start; gap:8px; }
  .dep-info .icon { flex: 0 0 auto; }
  .dep-info .text { flex: 1 1 auto; max-height: 8rem; overflow: auto; }
  /* Modal CSS moved to external file for CSP compatibility */
</style>
<link rel="stylesheet" href="{{ url_for('static', filename='weekview_modal.css') }}">


<section class="ua-section weekview-all">
  <div class="ua-card">
    <div style="display:flex;align-items:center;gap:8px;">
      <form class="week-select" method="get" action="{{ url_for('ui.weekview_ui') }}" style="display:flex;align-items:center;gap:8px;">
        <input type="hidden" name="site_id" value="{{ vm.site_id }}">
        <input type="hidden" name="department_id" value="">
        <input type="hidden" name="year" value="{{ vm.year }}">
        <label for="weekSelect" class="ua-muted">√Ör {{ vm.year }}</label>
        <select id="weekSelect" name="week" class="ua-select">
          {% for w in range(1,54) %}
            <option value="{{ w }}" {% if w == vm.week %}selected{% endif %}>Vecka {{ w }} ‚Äì {{ vm.year }}</option>
          {% endfor %}
        </select>
        <button class="yp-button" type="submit" aria-label="G√• till vald vecka">G√•</button>
      </form>
      {% set prev_w = vm.week-1 if vm.week>1 else 1 %}
      {% set next_w = vm.week+1 if vm.week<52 else 52 %}
      <a class="yp-button" href="{{ url_for('ui.weekview_ui', site_id=vm.site_id, year=vm.year, week=prev_w) }}" aria-label="F√∂reg√•ende vecka">‚óÄÔ∏é</a>
      <span>Vecka {{ vm.week }} ‚Äì {{ vm.year }}</span>
      <a class="yp-button" href="{{ url_for('ui.weekview_ui', site_id=vm.site_id, year=vm.year, week=next_w) }}" aria-label="N√§sta vecka">‚ñ∂Ô∏é</a>
    </div>
    {% if vm.allow_site_switch and vm.sites %}
      <div class="meta-row" style="margin-top:6px;">
        <strong>Aktiv site:</strong> {{ vm.site_name }}
        {% set base_q = {'year': vm.week, 'week': vm.week} %}
        <span style="margin-left:12px; color:#777;">Byt site:</span>
        {% for s in vm.sites %}
          {% if s.id != vm.active_site %}
            <a class="ua-link" href="{{ url_for('ui.weekview_ui', site_id=s.id, department_id='', year=vm.year, week=vm.week) }}" style="margin-left:8px;">{{ s.name }}</a>
          {% endif %}
        {% endfor %}
      </div>
    {% endif %}
    <div class="legend">
      <span class="pill">Boende = antal boende/m√•ltid</span>
      <span class="pill marked">Markerad = specialkost beh√∂vde anpassas</span>
      <span class="pill kvall">Kv√§ll markeras med svag ton</span>
    </div>
  </div>
</section>

{% set day_names = ['M√•n','Tis','Ons','Tors','Fre','L√∂r','S√∂n'] %}
{% set day_full_names = ['M√•ndag','Tisdag','Onsdag','Torsdag','Fredag','L√∂rdag','S√∂ndag'] %}

{% if not vm.departments or vm.departments|length == 0 %}
<section class="ua-section weekview-all">
  <div class="ua-card"><p class="ua-muted">Inga avdelningar</p></div>
</section>
{% endif %}

{% for dep in vm.departments %}
<section class="ua-section weekview-all veckovy-department-card" data-department-id="{{ dep.id }}" data-etag="{{ dep.etag }}">
  <div class="ua-card">
    <div class="dep-header">
      <h2>{{ dep.name }}</h2>
      <div class="meta-row">Vecka {{ vm.week }}, {{ vm.year }}</div>
      {% if vm.mode == 'kitchen' and dep.residents_configured is defined %}
        <div class="meta-row"><strong>{{ dep.residents_configured }} boende</strong></div>
      {% endif %}
    </div>
    {% if dep.notes %}
    <div class="dep-info" aria-label="Avdelningsinfo">
      <div class="icon">‚ÑπÔ∏è</div>
      <div class="text">{{ dep.notes }}</div>
    </div>
    {% endif %}
    <table class="ua-table weekview veckovy-table">
      <thead>
        <tr>
          <th></th>
          {% for dn in day_names %}
            {% set idx = loop.index0 %}
            {% set site_has = vm.menu_days_site if vm.menu_days_site is defined else [] %}
            {% set full_dn = day_full_names[idx] %}
            {% set has_menu = (site_has[idx] if (site_has and site_has|length>idx) else False) or ((vm.menu_data.get(full_dn) or {}).get('alt1') or (vm.menu_data.get(full_dn) or {}).get('alt2') or (vm.menu_data.get(full_dn) or {}).get('dessert') or (vm.menu_data.get(full_dn) or {}).get('kvall')) %}
            <th colspan="2">{{ dn }}{% if has_menu %}
              {% set legacy_days = ['Mon','Tue','Wed','Thu','Fri','Sat','Sun'] %}
              <button class="menu-icon veckovy-menu-icon" type="button" aria-label="Visa meny" data-day="{{ legacy_days[idx] }}">üçΩÔ∏è</button>
            {% endif %}</th>
          {% endfor %}
        </tr>
        <tr>
          <th></th>
          {% for dn in day_names %}
            <th>Lunch</th>
            <th>Kv√§ll</th>
          {% endfor %}
        </tr>
      </thead>
      <tbody>
        <tr class="boende-row">
          <td><strong>Boende</strong></td>
          {% for d in dep.days %}
            <td>{{ (d.residents or {}).lunch or 0 }}</td>
            <td class="kvall">{{ (d.residents or {}).dinner or 0 }}</td>
          {% endfor %}
        </tr>
        {% set diet_ids = [] %}
        {% if vm.mode == 'kitchen' and dep.linked_diet_ids is defined and dep.linked_diet_ids %}
          {% set diet_ids = dep.linked_diet_ids %}
        {% elif vm.mode == 'kitchen' and vm.diet_name_map is defined and vm.diet_name_map %}
          {% set diet_ids = vm.diet_name_map.keys() | list %}
        {% elif dep.days and dep.days|length > 0 %}
          {% for day in dep.days %}
            {% for it in (day.diets.lunch if day.diets and day.diets.lunch else []) %}
              {% if it.diet_type_id not in diet_ids %}
                {% set _ = diet_ids.append(it.diet_type_id) %}
              {% endif %}
            {% endfor %}
            {% for it in (day.diets.dinner if day.diets and day.diets.dinner else []) %}
              {% if it.diet_type_id not in diet_ids %}
                {% set _ = diet_ids.append(it.diet_type_id) %}
              {% endif %}
            {% endfor %}
          {% endfor %}
        {% endif %}
        {% for dtid in diet_ids %}
          <tr>
            <td>{{ vm.diet_name_map.get(dtid|int, dtid) }}</td>
            {% for i in range(0, dep.days|length) %}
              {% set day = dep.days[i] %}
              {% set day_index = i+1 %}
              {% set lunch_cell = (day.diets.lunch | selectattr('diet_type_id','equalto', dtid) | list | first) %}
              {% set dinner_cell = (day.diets.dinner | selectattr('diet_type_id','equalto', dtid) | list | first) %}
              {% set lunch_done = (dep.marks if dep.marks else []) | selectattr('meal','equalto','lunch_done') | selectattr('day_of_week','equalto', day_index) | selectattr('diet_type','equalto', dtid) | list | length > 0 %}
              {% set dinner_done = (dep.marks if dep.marks else []) | selectattr('meal','equalto','dinner_done') | selectattr('day_of_week','equalto', day_index) | selectattr('diet_type','equalto', dtid) | list | length > 0 %}
              {% set lunch_registered = (dep.reg_lunch_days if dep.reg_lunch_days is defined else []) and (day_index in dep.reg_lunch_days) %}
              {% set full_name = day_full_names[day_index-1] %}
              {% set has_alt2_menu = (vm.menu_data.get(full_name) or {}).get('alt2') %}
              <td class="diet-cell {% if lunch_cell and lunch_cell.marked %}marked{% endif %} {% if lunch_registered %}markerad{% endif %} {% if vm.mode == 'kitchen' and (day.alt2_lunch or has_alt2_menu) %}gulmarkerad{% endif %}" data-weekday="{{ day.weekday_name }}" data-meal="Lunch" data-diet-id="{{ dtid }}">
                {% if vm.mode == 'kitchen' %}
                  <button type="button"
                          class="kostcell kostcell-btn {% if lunch_done %}done-ring{% endif %}"
                          aria-label="Markera som klar"
                          data-kosttyp-id="{{ dtid }}"
                          data-department-id="{{ dep.id }}"
                          data-week="{{ vm.week }}"
                          data-day-index="{{ day_index }}"
                          data-meal="lunch">
                    <span class="kostcell-count">{{ lunch_cell.resident_count if lunch_cell else 0 }}</span>
                  </button>
                {% else %}
                  {{ lunch_cell.resident_count if lunch_cell else 0 }}
                {% endif %}
              </td>
              {% set dinner_registered = (dep.reg_dinner_days if dep.reg_dinner_days is defined else []) and (day_index in dep.reg_dinner_days) %}
              <td class="diet-cell kvall {% if dinner_cell and dinner_cell.marked %}marked{% endif %} {% if dinner_registered %}markerad{% endif %}" data-weekday="{{ day.weekday_name }}" data-meal="Kv√§ll" data-diet-id="{{ dtid }}">
                {% if vm.mode == 'kitchen' %}
                  <button type="button"
                          class="kostcell kostcell-btn {% if dinner_done %}done-ring{% endif %}"
                          aria-label="Markera som klar"
                          data-kosttyp-id="{{ dtid }}"
                          data-department-id="{{ dep.id }}"
                          data-week="{{ vm.week }}"
                          data-day-index="{{ day_index }}"
                          data-meal="dinner">
                    <span class="kostcell-count">{{ dinner_cell.resident_count if dinner_cell else 0 }}</span>
                  </button>
                {% else %}
                  {{ dinner_cell.resident_count if dinner_cell else 0 }}
                {% endif %}
              </td>
            {% endfor %}
          </tr>
        {% endfor %}
        {% if diet_ids|length == 0 %}
          <tr><td colspan="15"><p class="ua-muted">Inga specialkoster</p></td></tr>
        {% endif %}
      </tbody>
    </table>
    <p class="ua-muted">Klicka i rutan f√∂r att markera/avmarkera specialkost.</p>
  </div>
</section>
{% endfor %}

<script src="{{ url_for('static', filename='weekview_menu_modal.js') }}"></script>
<script>window.VECKOVY_MENU_DATA = {{ (vm.menu_data or {}) | tojson | safe }};</script>
{% if vm.mode == 'kitchen' %}
  <script src="{{ url_for('static', filename='js/kitchen_week.js') }}" defer></script>
{% endif %}

<div id="menuModal" class="menu-modal" role="dialog" aria-modal="true"></div>
<div class="snackbar" role="status" aria-live="polite" aria-atomic="true">Sparat</div>

{% endblock %}
