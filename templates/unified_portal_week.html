<!DOCTYPE html>
<html lang="sv">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Avdelningsvy ‚Äì Vecka {{ vm.week }}, {{ vm.year }}</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='unified_ui.css') }}">
  <link rel="stylesheet" href="{{ url_for('static', filename='unified_portal.css') }}">
  <script src="{{ url_for('static', filename='unified_portal.js') }}" defer></script>
  <script src="{{ url_for('static', filename='unified_ui.js') }}" defer></script>
  {% include 'includes/yuplan_header.html' ignore missing %}
  <style>
    .residents-counter { display:flex; flex-direction:column; align-items:center; font-size:0.75rem; opacity:0.85; margin-top:2px; }
    .res-icon { line-height:1; font-size:0.9rem; }
    .res-value { font-weight:600; }
  </style>
</head>
<body>
<header class="yp-header">
  <div class="yp-header__title">Avdelningsportalen</div>
  <div class="yp-header__meta">
    <span>Vecka {{ vm.week }}, {{ vm.year }}</span>
    <span>‚Ä¢ {{ vm.department_name }}</span>
    <span>‚Ä¢ {{ vm.site_name }}</span>
  </div>
</header>

<main class="portal-container"
  data-site-id="{{ vm.site_id }}"
  data-department-id="{{ vm.department_id }}"
  data-year="{{ vm.year }}"
  data-week="{{ vm.week }}">
  <section class="portal-week-header">
    <a href="{{ vm.back_url }}" class="yp-link">&larr; Till veck√∂versikten</a>

    <h1>Vecka {{ vm.week }} ‚Äì {{ vm.department_name }}</h1>
    <div class="portal-week-nav">
      <a class="yp-btn" href="/ui/portal/week?site_id={{ vm.site_id }}&department_id={{ vm.department_id }}&year={{ vm.nav_prev.year }}&week={{ vm.nav_prev.week }}" aria-label="F√∂reg√•ende vecka">&larr; F√∂reg√•ende</a>
      <form method="get" action="/ui/portal/week" class="portal-week-jump" style="display:inline-flex;gap:6px;align-items:center;">
        <input type="hidden" name="site_id" value="{{ vm.site_id }}">
        <input type="hidden" name="department_id" value="{{ vm.department_id }}">
        <label>Hoppa till:</label>
        <input type="number" min="2000" max="2100" name="year" value="{{ vm.year }}" style="width:80px;">
        <input type="number" min="1" max="53" name="week" value="{{ vm.week }}" style="width:60px;">
        <button type="submit" class="yp-btn">G√•</button>
      </form>
      <a class="yp-btn" href="/ui/portal/week?site_id={{ vm.site_id }}&department_id={{ vm.department_id }}&year={{ vm.nav_next.year }}&week={{ vm.nav_next.week }}" aria-label="N√§sta vecka">N√§sta &rarr;</a>
    </div>
    <p>Boendeantal: {{ vm.residents_count }}</p>
    <p>Boende: {{ vm.residents_count }}</p>

    <p>Avdelning: {{ vm.department_name }}</p>

    {% if not vm.department_id %}
      <div class="yp-banner yp-banner-warning">Ingen avdelning vald (portal-login kr√§vs)</div>
      {% if vm.site_departments and vm.site_departments|length > 0 %}
      <form method="post" action="/ui/portal/select-department" class="portal-department-picker" style="margin:10px 0;display:flex;gap:8px;align-items:center;">
        <input type="hidden" name="site_id" value="{{ vm.site_id }}">
        <input type="hidden" name="year" value="{{ vm.year }}">
        <input type="hidden" name="week" value="{{ vm.week }}">
        <label for="portal-department-select">V√§lj avdelning:</label>
        <select id="portal-department-select" name="department_id">
          {% for d in vm.site_departments %}
            <option value="{{ d.id }}">{{ d.name }}</option>
          {% endfor %}
        </select>
        <button type="submit" class="yp-btn">√ñppna portal</button>
      </form>
      {% endif %}
    {% endif %}

    {% if vm.info_text %}
      <p class="portal-note">{{ vm.info_text }}</p>
    {% endif %}

    <p class="portal-department-special">
      Specialkost p√• avdelningen
    </p>

    <p class="portal-help">
      Om n√•got inte st√§mmer ‚Äì kontakta k√∂ket eller admin.
    </p>

    {% if vm.has_menu %}
      {% if vm.is_completed %}
        <span class="status-pill status-pill--done">Klar</span>
        <p class="status-text">Veckan √§r klar.</p>
      {% elif vm.needs_choices %}
        <span class="status-pill status-pill--needs">Beh√∂ver val</span>
        <p class="status-text">Veckan √§r inte klar ‚Äì det saknas val vissa dagar.</p>
      {% endif %}
    {% else %}
      <span class="status-pill status-pill--no-menu">Ingen meny</span>
      <p class="status-text">K√∂ket har inte lagt in meny √§n.</p>
      <p class="status-text">Veckan √§r inte klar</p>
    {% endif %}
  </section>
<main class="portal-container"
  data-site-id="{{ vm.site_id }}"
  data-department-id="{{ vm.department_id }}"
  data-year="{{ vm.year }}"
  data-week="{{ vm.week }}">
  <nav class="breadcrumb" aria-label="Br√∂dsmulor">
    <a href="#" tabindex="-1">Portal</a>
    <span class="breadcrumb-sep">/</span>
    <a href="{% if vm.is_enhetsportal %}/ui/portal/weeks{% else %}/portal/weeks{% endif %}?site_id={{ vm.site_id }}&department_id={{ vm.department_id }}">{{ vm.department_name }}</a>
    <span class="breadcrumb-sep">/</span>
    <span class="breadcrumb-current">Vecka {{ vm.week }}</span>
  </nav>
  

  <form method="post" action="/ui/portal/week/save" class="portal-week-form">
    <input type="hidden" name="site_id" value="{{ vm.site_id }}">
    <input type="hidden" name="department_id" value="{{ vm.department_id }}">
    <input type="hidden" name="year" value="{{ vm.year }}">
    <input type="hidden" name="week" value="{{ vm.week }}">
  <section class="portal-day-grid" aria-label="Veckans meny">
    {% for day in vm.days %}
    <article class="yp-card portal-day-card" data-is-today="{{ 'true' if day.is_today else 'false' }}">
      <div class="portal-day-card__header {{ 'is-today' if day.is_today }}">
        <div class="portal-day-card__title">
          {{ day.weekday_name }} {{ day.date | replace('-', '/') }}
        </div>
        {% if day.is_today %}
        <span class="yp-badge yp-badge-info">Idag</span>
        {% endif %}
      </div>
      <div style="position:absolute;left:-9999px;" aria-hidden="true">Boende: {{ day.residents.lunch }}</div>

      <div class="meal-block" role="button" tabindex="0"
        aria-label="Lunch {{ day.weekday_name }} {{ day.date }}{{ ', Registrerad' if day.registered.lunch else '' }}{{ ', Alt 2' if day.alt2_lunch else '' }}"
        data-day="{{ day.date }}" data-day-key="{{ day.date }}" data-meal="lunch" data-can-choose-lunch="{{ 'true' if day.can_choose_lunch else 'false' }}">
        <div class="meal-block__header">
          <span class="meal-icon" aria-hidden="true">üçΩ</span>
          <span class="meal-label">LUNCH</span>
          <span class="meal-badges">
            {% if day.can_choose_lunch %}
              <span class="yp-badge yp-badge-info">Valbar (Alt1/Alt2)</span>
            {% else %}
              <span class="yp-badge yp-badge-muted">Endast menyvisning</span>
            {% endif %}
            {% if not day.registered.lunch %}
              <span class="yp-badge yp-badge-muted">Ej gjord</span>
            {% endif %}
          </span>
        </div>
        <div class="meal-text meal-text--alt1">{{ day.menu.lunch.alt1 or 'Ingen r√§tt' }}</div>
        {% if day.menu.lunch.alt2 %}
        <div class="meal-text meal-text--alt2">ALT 2: {{ day.menu.lunch.alt2 }}</div>
        <span class="yp-badge yp-badge-warning">‚ö° Alt 2</span>
        {% endif %}
        {% if day.menu.lunch.dessert %}
        <div class="meal-text meal-text--dessert">{{ day.menu.lunch.dessert }}</div>
        {% endif %}
        {% if day.can_choose_lunch %}
        <div class="meal-choice">
          <label class="yp-radio">
            <input type="radio" name="choice_{{ day.day_index }}" value="alt1" {% if day.lunch_choice != 'alt2' %}checked{% endif %}>
            <span>Alt 1</span>
          </label>
          {% if day.menu.lunch.alt2 %}
          <label class="yp-radio">
            <input type="radio" name="choice_{{ day.day_index }}" value="alt2" {% if day.lunch_choice == 'alt2' %}checked{% endif %}>
            <span>Alt 2</span>
          </label>
          {% else %}
          <label class="yp-radio yp-radio--disabled">
            <input type="radio" name="choice_{{ day.day_index }}" value="alt2" disabled>
            <span>Alt 2 (saknas)</span>
          </label>
          {% endif %}
        </div>
        {% endif %}
        <div class="residents-counter">
          <span class="res-icon">üë•</span>
          <span class="res-value">{{ day.residents.lunch }}</span>
        </div>
        {% if day.residents.lunch and day.residents.lunch > 0 %}
        <div class="residents-count">Boende: {{ day.residents.lunch }}</div>
        {% endif %}
        {% if day.default_diets and day.default_diets|length > 0 %}
        <div class="meal-diets" aria-hidden="true">
          {% for d in day.default_diets %}
          <span class="yp-badge yp-badge-secondary">{{ d.name }} [{{ d.count }}]</span>
          {% endfor %}
        </div>
        {% endif %}
      </div>

      {% if vm.force_show_dinner or day.menu.dinner.alt1 or day.menu.dinner.alt2 %}
      <div class="meal-block" role="button" tabindex="0"
        aria-label="Kv√§llsmat {{ day.weekday_name }} {{ day.date }}{{ ', Registrerad' if day.registered.dinner else '' }}"
        data-day="{{ day.date }}" data-day-key="{{ day.date }}" data-meal="dinner">
        <div class="meal-block__header">
          <span class="meal-icon" aria-hidden="true">üåô</span>
          <span class="meal-label">KV√ÑLLSMAT</span>
          <span class="meal-badges">
            <span class="yp-badge yp-badge-muted">Endast menyvisning</span>
            {% if not day.registered.dinner %}
              <span class="yp-badge yp-badge-muted">Ej gjord</span>
            {% endif %}
          </span>
        </div>
        {% if day.menu.dinner.alt1 or day.menu.dinner.alt2 %}
          <div class="meal-text meal-text--alt1">{{ day.menu.dinner.alt1 }}</div>
          {% if day.menu.dinner.alt2 %}
          <div class="meal-text meal-text--alt2">{{ day.menu.dinner.alt2 }}</div>
          {% endif %}
        {% else %}
          <div class="meal-text meal-text--alt1">Ingen r√§tt</div>
        {% endif %}
        <div class="residents-counter">
          <span class="res-icon">üë•</span>
          <span class="res-value">{{ day.residents.dinner }}</span>
        </div>
      </div>
      {% endif %}
    </article>
    {% endfor %}
  </section>
  <div class="portal-week-actions">
    <button type="submit" class="yp-btn"{% if not vm.department_id %} disabled{% endif %}>Spara menyval</button>
  </div>
  </form>

  {% if vm.show_kost_grid %}
  <h1 class="veckovy-title">Veckovy ‚Äì k√∂k</h1>
  <section class="veckovy-day-summary" aria-live="polite">
    <h3>Fokusdag</h3>
    <p class="veckovy-day-summary__label">Ingen dag vald</p>
    <p class="veckovy-day-summary__totals"></p>
  </section>
  <section class="veckovy-grid">
    <span style="position:absolute;left:-9999px;top:-9999px;" aria-hidden="true">.veckovy-department-card .veckovy-table .kostcell</span>
    {% for grid in vm.kost_grids %}
    <section class="veckovy-department-card">
      <header class="veckovy-department-card__header">
        <div class="veckovy-department-card__title">
          <h2>{{ grid.department_name }}</h2>
          <span class="veckovy-department-card__residents">{{ grid.residents_by_day.values()|sum }} boende</span>
        </div>
        {% if grid.info_text %}
        <div class="veckovy-department-card__info">{{ grid.info_text }}</div>
        {% endif %}
      </header>
      <div class="veckovy-department-card__table-wrapper">
        <table class="veckovy-table" aria-label="Veckovy f√∂r {{ grid.department_name }}">
          <thead>
            <tr>
              <th>Specialkost</th>
              {% for day in vm.days_ordered %}
              <th class="veckovy-day-header" data-day-index="{{ day.index }}">
                <div class="veckovy-day-header__title">{{ day.label_short }}</div>
                {% if day.has_menu %}
                <button type="button" class="veckovy-menu-icon" data-day="{{ day.index }}" data-day-key="{{ day.key }}">üçΩ</button>
                {% endif %}
                {% if day.planera_lunch_url %}
                <a href="{{ day.planera_lunch_url }}" class="veckovy-day-planera-link" title="√ñppna planering f√∂r lunch denna dag">Planera</a>
                {% endif %}
              </th>
              {% endfor %}
            </tr>
          </thead>
          <tbody>
            {% for row in grid.rows %}
            <tr>
              <td>{{ row.kosttyp_name }}</td>
              {% for cell in row.cells %}
              <td class="kostcell{% if cell.is_marked %} markerad{% endif %}{% if cell.is_alt2 %} gulmarkerad{% endif %}{% if cell.is_dinner %} kv√§ll{% endif %}{% if cell.is_day_start %} dagstart{% endif %}{% if cell.heat_level == 'low' %} heat-low{% endif %}{% if cell.heat_level == 'medium' %} heat-medium{% endif %}{% if cell.heat_level == 'high' %} heat-high{% endif %}"
                  data-kosttyp-id="{{ cell.kosttyp_id }}"
                  data-department-id="{{ cell.department_id }}"
                  data-week="{{ cell.week }}"
                  data-day="{{ cell.day_index }}"
                  data-weekday-key="{{ cell.weekday_key }}"
                  data-meal="{{ cell.meal }}">
                {{ cell.count }}
              </td>
              {% endfor %}
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </section>
    {% endfor %}
  </section>
  <script>
    window.VECKOVY_MENU_DATA = {{ vm.menu_by_day | tojson | safe }};
    window.VECKOVY_TODAY_DAY_INDEX = {{ vm.today_day_index if vm.today_day_index is not none else 'null' }};
  </script>
  {% endif %}
</main>

{% include 'includes/yuplan_footer.html' ignore missing %}
</body>
</html>
