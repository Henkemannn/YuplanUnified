<!DOCTYPE html>
<html lang="sv">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>{% block title %}Yuplan{% endblock %}</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="/static/css/main.css?v={{ asset_version|default('') }}">
  <link rel="stylesheet" href="{{ url_for('static', filename='unified_ui.css') }}">
  <link rel="manifest" href="/manifest.webmanifest?v={{ asset_version|default('') }}">
  <link rel="icon" href="/favicon.ico?v={{ asset_version|default('') }}">
  <link rel="apple-touch-icon" href="/static/apple-touch-icon.png?v={{ asset_version|default('') }}" sizes="180x180">
  <link rel="mask-icon" href="/static/safari-pinned-tab.svg?v={{ asset_version|default('') }}" color="#111827">
  <meta name="theme-color" content="#fafafa" media="(prefers-color-scheme: light)">
  <meta name="theme-color" content="#0b1220" media="(prefers-color-scheme: dark)">
  <!-- Inline styles removed for CSP; rely on external CSS -->
  {% block head %}{% endblock %}
</head>
<body data-site-context-version="{{ session.get('site_context_version') or '' }}">
{% if not hide_global_nav %}
<nav class="main-nav">
  {% set is_systemadmin_ctx = (request.endpoint=='ui.admin_system_page' or request.path.startswith('/ui/admin/system')) %}
  {% if is_systemadmin_ctx and has_role('superuser') %}
    {# Systemadmin context: show only systemadmin navigation #}
    <a href="{{ url_for('ui.admin_system_page') }}" class="active">Systemadministration</a>
    {# Optional: add Kunder/Logga ut links if available in routes #}
  {% else %}
    <a href="{{ url_for('ui.weekview_ui') }}">Veckovy</a>
    <a href="{{ url_for('ui.portal_week') }}" class="{% if request.path.startswith('/portal/week') %}active{% endif %}">Avdelningsportal</a>
    <a href="{{ url_for('ui.planera_day_ui_v2') }}">Planera</a>
    <a href="{{ url_for('ui.weekview_report_ui') }}">Rapport</a>
    <a href="{{ url_for('ui.admin_dashboard') }}">Admin</a>
    {% if has_role('admin','superuser') %}
      <a href="{{ url_for('ui.admin_diets_page') }}" class="{% if request.endpoint=='ui.admin_diets_page' %}active{% endif %}">Specialkost</a>
    {% endif %}
    {% if has_role('superuser') %}
      <a href="{{ url_for('ui.admin_system_page') }}" class="{% if request.endpoint=='ui.admin_system_page' or request.path.startswith('/ui/admin/system') %}active{% endif %}">Systemadministration</a>
    {% endif %}
  {% endif %}
</nav>
{% endif %}
{% if staging_demo and not hide_global_nav %}
<div class="staging-banner">
  <strong>Staging Demo</strong> — ETag/If-Match/If-None-Match aktiverat. Data kan rensas.
  <span class="staging-note">Ej produktion</span>
  </div>
{% endif %}
{% if g.get('impersonating') %}
<div class="impersonation-banner">
  <strong>Du är inloggad som admin för {{ current_site_name or ('tenant ' ~ tenant_id) }} (impersonering).</strong>
  <span style="margin-left:8px">Återstående {{ g.get('impersonation_remaining', '?') }}s</span>
  {% if g.get('impersonation_reason') %}<span style="margin-left:8px">Orsak: {{ g.get('impersonation_reason') }}</span>{% endif %}
  <form id="imp-stop" method="post" action="/superuser/impersonate/stop" class="inline-form">
    {% if g.features.get('strict_csrf') %}{{ csrf_token_input()|safe }}{% endif %}
    <button class="impersonation-stop-btn">Stoppa impersonering</button>
  </form>
</div>
<!-- Inline script removed for CSP; form posts normally -->
{% endif %}
{% if not hide_global_nav %}
<header>
  <div class="wrap">
    <nav>
      <strong>Yuplan</strong>
      · <a href="{{ url_for('ui.weekview_ui') }}" class="{% if request.endpoint=='ui.weekview_ui' %}active{% endif %}">Översikt</a>
      {% if current_user %}<span class="pill">Tenant {{ tenant_id }}</span>{% endif %}
      <span style="float:right">
        {% if current_user and current_user.role in ('admin','superuser') %}
          <a class="btn" href="{{ url_for('export_api.export_notes') }}">Exportera Notes</a>
          <a class="btn" style="margin-left:8px" href="{{ url_for('export_api.export_tasks') }}">Exportera Tasks</a>
        {% endif %}
      </span>
    </nav>
  </div>
</header>
{% endif %}
<main class="wrap">
  <!-- layout markers removed to satisfy CSP -->
  {% block content %}{% endblock %}
</main>
<footer>
  Yuplan &copy; {{ 2025 }} • Request ID: <span id="reqid">{{ g.request_id if g.request_id else '' }}</span>
  {% if has_role('admin','superuser') %}
    <a class="support-link" href="{{ url_for('support.support_home').replace('/admin/support/', '/admin/support/ui') }}" target="_blank" rel="noopener">Support</a>
  {% endif %}
  {% if dev_mode %}
  <div class="dev-footer" style="margin-top:8px;font-size:12px;color:#6b7280">
    Runtime: {{ runtime_branch or 'unknown' }}@{{ runtime_commit or 'unknown' }}
    {% if runtime_sqlite_file %} | DB: {{ runtime_sqlite_file }}{% endif %}
  </div>
  {% endif %}
</footer>
{% block scripts %}{% endblock %}
{% if g.features.get('strict_csrf') %}<meta name="csrf-token" content="{{ csrf_token }}">{% endif %}
{% if g.features.get('strict_csrf') %}<script src="/static/js/http.js"></script>{% endif %}
</body>
</html>