<!doctype html>
<html lang="sv">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Dashboard</title>
  <link rel="icon" href="{{ url_for('static', filename='logo/YuplanBlue.svg') }}" type="image/svg+xml" />
  <link rel="stylesheet" href="/static/css/dashboard.css" />
  <style>
    .brand { display:flex; align-items:center; gap:.5rem; text-decoration:none; }
    .brand-wordmark { height:34px; display:block; inline-size:auto; }
    @media (max-width: 420px){ .brand-wordmark { height:28px; } }
  </style>
</head>
<body>
  <div class="wrap">
    <header class="topbar">
      <a class="brand" href="/">
        <img class="brand-wordmark" src="{{ url_for('static', filename='logo/YuplanWordmark.svg') }}" alt="Yuplan" />
        <h1 style="margin:0;font-size:1.35rem;line-height:1;">Dashboard</h1>
      </a>
    </header>

    <section class="grid">
      <div class="card wide" id="widget-today-menu">
        <h2>Snabbstart</h2>
        <p>Gå till Kockens arbetsvy eller visa API-specifikationen.</p>
        <div class="actions">
          <a class="button" href="/ui/cook">Öppna Kockvy</a>
          <a class="button" href="/openapi.json" target="_blank" rel="noopener">API-spec</a>
        </div>
      </div>

      <div class="card" id="widget-quickstart">
        <h3>Snabbval</h3>
        <div class="actions">
          {% if has_role('admin') or has_role('editor') %}
            <a class="button" href="/weekview">Veckovy</a>
            <a class="button" href="/report">Rapport</a>
            <a class="button" href="/planning">Planering</a>
          {% else %}
            <button class="button" disabled title="Insufficient permissions">Veckovy</button>
            <button class="button" disabled title="Insufficient permissions">Rapport</button>
            <button class="button" disabled title="Insufficient permissions">Planering</button>
          {% endif %}
        </div>
      </div>

      <div class="card" id="widget-alerts">
        <h3>Alerts & Status</h3>
        <ul>
          <li>Saknat boendeantal</li>
          <li>Stale data (vecka)</li>
          <li>Alt 2 planerad idag</li>
        </ul>
      </div>

      <div class="card" id="widget-weekview-launch">
        <h3>Veckovy (parametrar)</h3>
        <p class="muted">Fyll i Site + Avdelning + År + Vecka. Kräver att feature flag <code>ff.weekview.enabled</code> är aktiv och data finns.</p>
        <form id="weekview-form" novalidate style="display:flex;flex-direction:column;gap:.5rem;">
          <div style="display:flex;gap:.5rem;flex-wrap:wrap;">
            <label style="flex:1;min-width:120px;">Site ID
              <input name="site_id" required pattern="^[A-Za-z0-9-]+$" placeholder="t.ex. UUID" />
            </label>
            <label style="flex:1;min-width:120px;">Avd ID
              <input name="department_id" required pattern="^[A-Za-z0-9-]+$" placeholder="t.ex. UUID" />
            </label>
            <label style="flex:1;min-width:100px;">År
              <input name="year" required pattern="^[0-9]{4}$" inputmode="numeric" value="2025" />
            </label>
            <label style="flex:1;min-width:90px;">Vecka
              <input name="week" required pattern="^[0-9]{1,2}$" inputmode="numeric" value="47" />
            </label>
          </div>
          <div style="display:flex;gap:.5rem;align-items:center;flex-wrap:wrap;">
            <button type="submit" class="button">Öppna veckovy</button>
            <span id="weekview-error" class="muted" aria-live="polite"></span>
            <a class="button subtle" href="/admin/feature_flags" target="_blank" rel="noopener">Visa aktiva feature flags</a>
          </div>
        </form>
        <script>
        (function(){
          const form = document.getElementById('weekview-form');
          const errEl = document.getElementById('weekview-error');
          form.addEventListener('submit', function(ev){
            ev.preventDefault();
            errEl.textContent='';
            const fd = new FormData(form);
            const site_id = fd.get('site_id')?.trim();
            const department_id = fd.get('department_id')?.trim();
            const year = fd.get('year')?.trim();
            const week = fd.get('week')?.trim();
            // Basic validation
            if(!site_id || !department_id || !year || !week){
              errEl.textContent='Alla fält krävs.'; return;
            }
            if(!/^[A-Za-z0-9-]+$/.test(site_id) || !/^[A-Za-z0-9-]+$/.test(department_id)) { errEl.textContent='Ogiltigt ID-format.'; return; }
            if(!/^\d{4}$/.test(year)) { errEl.textContent='År måste vara 4 siffror.'; return; }
            const w = parseInt(week,10);
            if(!(w>=1 && w<=53)) { errEl.textContent='Vecka måste vara 1-53.'; return; }
            const url = `/ui/weekview?site_id=${encodeURIComponent(site_id)}&department_id=${encodeURIComponent(department_id)}&year=${encodeURIComponent(year)}&week=${encodeURIComponent(week)}`;
            window.location.href = url;
          });
        })();
        </script>
      </div>

      <div class="card" id="widget-dept-notes">
        <h3>Avdelningsnotiser</h3>
        <ul>
          <li>Påminnelse: Beställ mjölk till fredag</li>
          <li>Städ dag 2:a tisdagen varje månad</li>
          <li>Brandövning kl 14 på torsdag</li>
        </ul>
      </div>

      <div class="card" id="widget-tasks">
        <h3>Status</h3>
        <ul>
          <li>App: OK</li>
          <li>Version: 0.3.x</li>
        </ul>
      </div>

      <div class="card" id="widget-notes">
        <h3>Snarvägar</h3>
        <ul>
          <li><a href="/notes/">Notes API</a></li>
          <li><a href="/tasks/">Tasks API</a></li>
        </ul>
      </div>

      <div class="card" id="widget-shortcuts">
        <h3>Om</h3>
        <p class="muted">Denna dashboard är en enkel skalvy som kan utökas med widgetar och realtidsdata.</p>
      </div>
      <div class="card" id="widget-next">
        <h3>Nästa steg UI</h3>
        <ul class="muted" style="font-size:.85rem;line-height:1.3;">
          <li>Dynamisk laddning av veckodata (fetch) med skeleton-state.</li>
          <li>Global toppmeny (Veckovy, Rapport, Export, Inställningar).</li>
          <li>Tillgänglighet: ARIA-landmarks + fokusindikatorer.</li>
          <li>Responsiv layout: stapla kort på mobil.</li>
          <li>Feature flag badges & snabb toggling (admin).</li>
        </ul>
      </div>
    </section>
  </div>
</body>
</html>
