document.addEventListener('DOMContentLoaded',()=>{
  const main=document.querySelector('main[data-tenant-id]'); if(!main) return; const tid=main.getAttribute('data-tenant-id');
  const token=document.querySelector('meta[name="csrf-token"]')?.content||'';
  async function load(){ try{ const r=await fetch(`/api/superuser/tenants/${tid}/modules`,{credentials:'same-origin'}); const d=await r.json(); const ul=document.getElementById('tm-list'); if(!ul) return; ul.innerHTML=''; (d.items||[]).forEach(it=>{ const li=document.createElement('li'); li.innerHTML=`<button class="yu-btn yu-btn--soft" data-key="${it.key}" data-testid="tm-toggle-${it.key}" aria-pressed="${it.enabled}">${it.name} — ${it.enabled?'På':'Av'}</button>`; const b=li.querySelector('button'); b.addEventListener('click', async (e)=>{ const btn=e.currentTarget; btn.disabled=true; try{ const res=await fetch(`/api/superuser/tenants/${tid}/modules/toggle`,{method:'POST', headers:{'Content-Type':'application/json','X-CSRF-Token':token}, credentials:'same-origin', body: JSON.stringify({module_key: btn.getAttribute('data-key')})}); const j=await res.json().catch(()=>({enabled:btn.getAttribute('aria-pressed')==='true'})); const en=!!j.enabled; btn.setAttribute('aria-pressed', String(en)); btn.textContent=`${it.name} — ${en?'På':'Av'}`; } finally { btn.disabled=false; } }); ul.appendChild(li); }); }catch(_){ /* ignore */ } }
  const tab=document.getElementById('tab-modules'); if(tab){ tab.addEventListener('click', load, {once:true}); }
  const panel=document.getElementById('panel-modules'); if(panel && !panel.hidden){ load(); }
});